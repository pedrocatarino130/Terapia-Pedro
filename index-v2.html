<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Espa√ßo Terap√™utico - DBT v2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6b5b95;
            --secondary: #88b0d3;
            --accent: #ffb447;
            --success: #82ca9d;
            --danger: #f67280;
            --bg-light: #f8f9fa;
            --bg-dark: #1a1a2e;
            --text-light: #333;
            --text-dark: #f0f0f0;
            --card-light: #ffffff;
            --card-dark: #16213e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .dark-mode .header {
            background: rgba(22, 33, 62, 0.95);
            color: var(--text-dark);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .logo h1 {
            font-size: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .backup-badge {
            background: rgba(130, 202, 157, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--success);
            cursor: pointer;
            transition: all 0.3s;
        }

        .backup-badge:hover {
            background: rgba(130, 202, 157, 0.4);
        }

        .backup-badge.warning {
            background: rgba(246, 114, 128, 0.2);
            color: var(--danger);
        }

        .theme-toggle {
            width: 50px;
            height: 26px;
            background: var(--secondary);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle::after {
            content: 'üåû';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s;
        }

        .dark-mode .theme-toggle::after {
            transform: translateX(24px);
            content: 'üåô';
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .nav-tabs {
            background: rgba(22, 33, 62, 0.9);
        }

        .nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: rgba(107, 91, 149, 0.1);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            min-height: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .content-area {
            background: rgba(22, 33, 62, 0.95);
            color: var(--text-dark);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .dashboard-card {
            background: linear-gradient(135deg, #2d3561 0%, #1e2749 100%);
        }

        .mood-tracker {
            text-align: center;
        }

        .mood-scale {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .mood-emoji {
            font-size: 35px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 10px;
            border-radius: 10px;
        }

        .mood-emoji:hover {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.3);
        }

        .mood-emoji.selected {
            background: var(--accent);
            transform: scale(1.1);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary);
        }

        .dark-mode label {
            color: var(--secondary);
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .dark-mode input,
        .dark-mode textarea,
        .dark-mode select {
            background: var(--bg-dark);
            color: var(--text-dark);
            border-color: #3a3a3a;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(107, 91, 149, 0.1);
        }

        input.error, textarea.error, select.error {
            border-color: var(--danger);
        }

        .field-error {
            color: var(--danger);
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .field-error.visible {
            display: block;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(107, 91, 149, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .period-btn {
            padding: 8px 16px;
            margin-right: 5px;
            background: rgba(136, 176, 211, 0.2);
            border: 2px solid var(--secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .period-btn:hover {
            background: var(--secondary);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        .dark-mode .modal-content {
            background: var(--card-dark);
            color: var(--text-dark);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        /* Emotion history */
        .emotion-log {
            background: rgba(255, 255, 255, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
        }

        .dark-mode .emotion-log {
            background: rgba(0, 0, 0, 0.3);
        }

        .note-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .nav-tabs {
                justify-content: center;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            animation: slideIn 0.3s;
            max-width: 300px;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">üå±</div>
                <div>
                    <h1>Meu Espa√ßo Terap√™utico v2</h1>
                    <small id="dataStatus">Carregando...</small>
                </div>
            </div>
            <div class="header-controls">
                <div class="backup-badge" id="backupBadge" onclick="showBackupModal()">
                    <span id="backupText">√öltimo backup: nunca</span>
                </div>
                <span id="currentDate"></span>
                <div class="theme-toggle" onclick="toggleTheme()"></div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard" onclick="switchTab('dashboard', this)">
                <span>üìä</span> Dashboard
            </button>
            <button class="nav-tab" data-tab="emotions" onclick="switchTab('emotions', this)">
                <span>üí≠</span> Emo√ß√µes
            </button>
            <button class="nav-tab" data-tab="mindfulness" onclick="switchTab('mindfulness', this)">
                <span>üßò</span> Mindfulness
            </button>
            <button class="nav-tab" data-tab="sessions" onclick="switchTab('sessions', this)">
                <span>üìù</span> Sess√µes
            </button>
            <button class="nav-tab" data-tab="settings" onclick="switchTab('settings', this)">
                <span>‚öôÔ∏è</span> Configura√ß√µes
            </button>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2>Como voc√™ est√° hoje?</h2>

                <div class="dashboard-grid">
                    <div class="dashboard-card mood-tracker">
                        <h3>Registro R√°pido de Humor</h3>
                        <div class="mood-scale">
                            <span class="mood-emoji" onclick="selectMood(1, this)" title="Muito mal">üòî</span>
                            <span class="mood-emoji" onclick="selectMood(2, this)" title="Mal">üòï</span>
                            <span class="mood-emoji" onclick="selectMood(3, this)" title="Neutro">üòê</span>
                            <span class="mood-emoji" onclick="selectMood(4, this)" title="Bem">üôÇ</span>
                            <span class="mood-emoji" onclick="selectMood(5, this)" title="Muito bem">üòä</span>
                        </div>
                        <div class="form-group">
                            <textarea id="moodNote" rows="2" placeholder="Notas opcionais..."></textarea>
                        </div>
                        <button class="btn btn-success" onclick="saveMood()">Registrar Humor</button>
                    </div>

                    <div class="dashboard-card">
                        <h3>Resumo de Hoje</h3>
                        <p><strong>Registros:</strong></p>
                        <ul id="todaySummary" style="margin-left: 20px; margin-top: 10px;">
                            <li>Carregando...</li>
                        </ul>
                    </div>

                    <div class="dashboard-card">
                        <h3>Compara√ß√£o Semanal</h3>
                        <div id="weeklyComparison">
                            <p><strong>Semana atual vs anterior:</strong></p>
                            <div id="comparisonStats" style="margin-top: 10px;">
                                Carregando...
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h3>Tend√™ncia de Humor</h3>
                        <div>
                            <button class="period-btn" onclick="changeMoodPeriod(7)">7 dias</button>
                            <button class="period-btn" onclick="changeMoodPeriod(14)">14 dias</button>
                            <button class="period-btn" onclick="changeMoodPeriod(30)">30 dias</button>
                        </div>
                    </div>
                    <canvas id="moodChart" style="max-height: 300px;"></canvas>
                </div>

                <div class="dashboard-card" style="margin-top: 20px;">
                    <h3>Emo√ß√µes da Semana (Heatmap)</h3>
                    <div id="emotionHeatmap" style="margin-top: 15px;">
                        Carregando...
                    </div>
                </div>
            </div>

            <!-- Emotions Tab -->
            <div id="emotions" class="tab-content">
                <h2>Registro de Emo√ß√µes</h2>

                <div class="form-group">
                    <label>Que emo√ß√£o voc√™ est√° sentindo? *</label>
                    <select id="emotionType">
                        <option value="">Selecione...</option>
                        <option value="alegria">Alegria</option>
                        <option value="tristeza">Tristeza</option>
                        <option value="raiva">Raiva</option>
                        <option value="medo">Medo</option>
                        <option value="ansiedade">Ansiedade</option>
                        <option value="calma">Calma</option>
                        <option value="frustra√ß√£o">Frustra√ß√£o</option>
                        <option value="esperan√ßa">Esperan√ßa</option>
                        <option value="vergonha">Vergonha</option>
                    </select>
                    <div class="field-error" id="emotionTypeError">Selecione uma emo√ß√£o</div>
                </div>

                <div class="form-group">
                    <label>Intensidade (0-10) *</label>
                    <input type="range" id="emotionIntensity" min="0" max="10" value="5">
                    <span id="intensityValue">5</span>
                </div>

                <div class="form-group">
                    <label>O que disparou essa emo√ß√£o?</label>
                    <textarea id="emotionTrigger" rows="3" placeholder="Descreva a situa√ß√£o... (opcional)"></textarea>
                </div>

                <div class="form-group">
                    <label>Sensa√ß√µes f√≠sicas</label>
                    <textarea id="physicalSensations" rows="2" placeholder="O que voc√™ sente no corpo? (opcional)"></textarea>
                </div>

                <div class="form-group">
                    <label>Pensamentos</label>
                    <textarea id="emotionThoughts" rows="2" placeholder="O que passa pela sua mente? (opcional)"></textarea>
                </div>

                <div class="form-group">
                    <label>Impulso de a√ß√£o</label>
                    <textarea id="actionUrge" rows="2" placeholder="O que voc√™ tem vontade de fazer? (opcional)"></textarea>
                </div>

                <button class="btn btn-success" onclick="saveEmotion()">Registrar Emo√ß√£o</button>

                <h3 style="margin-top: 30px;">Hist√≥rico de Emo√ß√µes (√∫ltimas 10)</h3>
                <div id="emotionHistory"></div>
            </div>

            <!-- Mindfulness Tab -->
            <div id="mindfulness" class="tab-content">
                <h2>Pr√°ticas de Mindfulness</h2>

                <div class="dashboard-card">
                    <h3>Registrar Nova Pr√°tica</h3>

                    <div class="form-group">
                        <label>Tipo de Pr√°tica *</label>
                        <select id="practiceType">
                            <option value="">Selecione...</option>
                            <option value="formal">Medita√ß√£o Formal (sentado)</option>
                            <option value="informal">Mindfulness Informal</option>
                            <option value="breathing">Exerc√≠cio de Respira√ß√£o</option>
                            <option value="body-scan">Escaneamento Corporal</option>
                            <option value="walking">Caminhada Consciente</option>
                            <option value="eating">Alimenta√ß√£o Consciente</option>
                        </select>
                        <div class="field-error" id="practiceTypeError">Selecione um tipo de pr√°tica</div>
                    </div>

                    <div class="form-group">
                        <label>Dura√ß√£o (minutos) *</label>
                        <input type="number" id="practiceDuration" min="1" max="120" placeholder="Ex: 10">
                        <div class="field-error" id="practiceDurationError">Insira a dura√ß√£o</div>
                    </div>

                    <div class="form-group">
                        <label>Como foi a experi√™ncia?</label>
                        <textarea id="practiceNotes" rows="3" placeholder="Descreva sua pr√°tica... (opcional)"></textarea>
                    </div>

                    <button class="btn btn-success" onclick="savePractice()">Registrar Pr√°tica</button>
                </div>

                <h3 style="margin-top: 30px;">Hist√≥rico de Pr√°ticas</h3>
                <div id="practiceHistory">Carregando...</div>

                <div class="dashboard-card" style="margin-top: 20px;">
                    <h3>Estat√≠sticas de Mindfulness</h3>
                    <div id="practiceStats">Carregando...</div>
                </div>
            </div>

            <!-- Sessions Tab -->
            <div id="sessions" class="tab-content">
                <h2>Anota√ß√µes de Sess√µes Terap√™uticas</h2>

                <div class="dashboard-card">
                    <h3>Registrar Nova Sess√£o</h3>

                    <div class="form-group">
                        <label>Data da Sess√£o *</label>
                        <input type="date" id="sessionDate">
                        <div class="field-error" id="sessionDateError">Selecione uma data</div>
                    </div>

                    <div class="form-group">
                        <label>Resumo da Sess√£o *</label>
                        <textarea id="sessionSummary" rows="4" placeholder="O que foi discutido na sess√£o..."></textarea>
                        <div class="field-error" id="sessionSummaryError">Adicione um resumo</div>
                    </div>

                    <div class="form-group">
                        <label>Tarefas para Casa</label>
                        <textarea id="sessionHomework" rows="3" placeholder="- Tarefa 1&#10;- Tarefa 2&#10;- Tarefa 3 (opcional)"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Insights Importantes</label>
                        <textarea id="sessionInsights" rows="3" placeholder="Percep√ß√µes e aprendizados... (opcional)"></textarea>
                    </div>

                    <button class="btn btn-success" onclick="saveSession()">Salvar Sess√£o</button>
                </div>

                <h3 style="margin-top: 30px;">Sess√µes Anteriores</h3>
                <div id="sessionHistory">Carregando...</div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2>Configura√ß√µes e Backup</h2>

                <div class="dashboard-card">
                    <h3>Gest√£o de Dados</h3>
                    <p><strong>Sistema de persist√™ncia:</strong> localStorage + IndexedDB</p>
                    <p id="storageInfo">Carregando informa√ß√µes...</p>

                    <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="exportBackup()">üì• Baixar Backup JSON</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('restoreInput').click()">üì§ Restaurar Backup</button>
                        <input type="file" id="restoreInput" accept=".json" style="display: none;" onchange="restoreBackup(event)">
                    </div>
                </div>

                <div class="dashboard-card" style="margin-top: 20px;">
                    <h3>Estat√≠sticas</h3>
                    <div id="stats">Carregando...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Mood Modal -->
    <div id="quickMoodModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registro R√°pido</h2>
                <span class="close-modal" onclick="closeQuickModal()">&times;</span>
            </div>
            <p>Humor salvo com sucesso! üéâ</p>
        </div>
    </div>

    <script>
        // ============================================================================
        // DATA SCHEMA & VALIDATION
        // ============================================================================

        const Schema = {
            // Mood entry schema
            Mood: {
                validate(data) {
                    if (!data.value || data.value < 1 || data.value > 5) {
                        return { valid: false, error: 'Valor de humor inv√°lido (1-5)' };
                    }
                    return { valid: true };
                },
                create(value, note = '') {
                    return {
                        id: generateId(),
                        value: parseInt(value),
                        note: note.trim(),
                        timestamp: new Date().toISOString(),
                        date: new Date().toISOString().split('T')[0]
                    };
                }
            },

            // Emotion entry schema
            Emotion: {
                validate(data) {
                    if (!data.type || data.type.trim() === '') {
                        return { valid: false, error: 'Tipo de emo√ß√£o √© obrigat√≥rio' };
                    }
                    if (data.intensity === undefined || data.intensity < 0 || data.intensity > 10) {
                        return { valid: false, error: 'Intensidade inv√°lida (0-10)' };
                    }
                    return { valid: true };
                },
                create(type, intensity, details = {}) {
                    return {
                        id: generateId(),
                        type: type.trim(),
                        intensity: parseInt(intensity),
                        trigger: (details.trigger || '').trim(),
                        physical: (details.physical || '').trim(),
                        thoughts: (details.thoughts || '').trim(),
                        urge: (details.urge || '').trim(),
                        timestamp: new Date().toISOString(),
                        date: new Date().toISOString().split('T')[0]
                    };
                }
            },

            // Mindfulness practice schema
            Practice: {
                validate(data) {
                    if (!data.type || data.type.trim() === '') {
                        return { valid: false, error: 'Tipo de pr√°tica √© obrigat√≥rio' };
                    }
                    if (!data.duration || data.duration < 1) {
                        return { valid: false, error: 'Dura√ß√£o deve ser maior que 0' };
                    }
                    return { valid: true };
                },
                create(type, duration, notes = '') {
                    return {
                        id: generateId(),
                        type: type.trim(),
                        duration: parseInt(duration),
                        notes: notes.trim(),
                        timestamp: new Date().toISOString(),
                        date: new Date().toISOString().split('T')[0]
                    };
                }
            },

            // Session notes schema
            Session: {
                validate(data) {
                    if (!data.date || data.date.trim() === '') {
                        return { valid: false, error: 'Data da sess√£o √© obrigat√≥ria' };
                    }
                    if (!data.summary || data.summary.trim() === '') {
                        return { valid: false, error: 'Resumo da sess√£o √© obrigat√≥rio' };
                    }
                    return { valid: true };
                },
                create(date, summary, homework = '', insights = '') {
                    return {
                        id: generateId(),
                        date: date,
                        summary: summary.trim(),
                        homework: homework.trim(),
                        insights: insights.trim(),
                        timestamp: new Date().toISOString()
                    };
                }
            }
        };

        // ============================================================================
        // DUAL PERSISTENCE LAYER (localStorage + IndexedDB)
        // ============================================================================

        class DataStore {
            constructor() {
                this.db = null;
                this.dbName = 'TherapyAppDB';
                this.dbVersion = 1;
                this.ready = false;
            }

            async init() {
                try {
                    // Initialize IndexedDB
                    this.db = await this.openDatabase();
                    this.ready = true;
                    console.log('‚úÖ IndexedDB initialized');

                    // Migrate old localStorage data if needed
                    await this.migrateOldData();

                    return true;
                } catch (error) {
                    console.error('‚ùå IndexedDB initialization failed:', error);
                    console.log('‚ö†Ô∏è Falling back to localStorage only');
                    this.ready = false;
                    return false;
                }
            }

            openDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // Create object stores
                        if (!db.objectStoreNames.contains('moods')) {
                            const moodStore = db.createObjectStore('moods', { keyPath: 'id' });
                            moodStore.createIndex('date', 'date', { unique: false });
                            moodStore.createIndex('timestamp', 'timestamp', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('emotions')) {
                            const emotionStore = db.createObjectStore('emotions', { keyPath: 'id' });
                            emotionStore.createIndex('date', 'date', { unique: false });
                            emotionStore.createIndex('type', 'type', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('practices')) {
                            const practiceStore = db.createObjectStore('practices', { keyPath: 'id' });
                            practiceStore.createIndex('date', 'date', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('sessions')) {
                            const sessionStore = db.createObjectStore('sessions', { keyPath: 'id' });
                            sessionStore.createIndex('date', 'date', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('metadata')) {
                            db.createObjectStore('metadata', { keyPath: 'key' });
                        }
                    };
                });
            }

            async save(storeName, data) {
                // Save to localStorage (primary)
                try {
                    const key = `therapy_${storeName}`;
                    let items = JSON.parse(localStorage.getItem(key) || '[]');
                    items.push(data);
                    localStorage.setItem(key, JSON.stringify(items));
                } catch (error) {
                    console.error('localStorage save error:', error);
                    throw new Error('Falha ao salvar em localStorage');
                }

                // Save to IndexedDB (backup)
                if (this.ready && this.db) {
                    try {
                        await this.saveToIndexedDB(storeName, data);
                    } catch (error) {
                        console.warn('IndexedDB save warning:', error);
                        // Don't throw - localStorage is primary
                    }
                }

                return data;
            }

            saveToIndexedDB(storeName, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAll(storeName) {
                // Try localStorage first
                try {
                    const key = `therapy_${storeName}`;
                    const data = JSON.parse(localStorage.getItem(key) || '[]');
                    return data;
                } catch (error) {
                    console.error('localStorage read error:', error);

                    // Fallback to IndexedDB
                    if (this.ready && this.db) {
                        return await this.getAllFromIndexedDB(storeName);
                    }

                    return [];
                }
            }

            getAllFromIndexedDB(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            }

            async setMetadata(key, value) {
                localStorage.setItem(`therapy_meta_${key}`, JSON.stringify(value));

                if (this.ready && this.db) {
                    try {
                        const transaction = this.db.transaction(['metadata'], 'readwrite');
                        const store = transaction.objectStore('metadata');
                        store.put({ key, value, timestamp: new Date().toISOString() });
                    } catch (error) {
                        console.warn('Metadata save warning:', error);
                    }
                }
            }

            async getMetadata(key) {
                try {
                    const value = localStorage.getItem(`therapy_meta_${key}`);
                    return value ? JSON.parse(value) : null;
                } catch (error) {
                    return null;
                }
            }

            async migrateOldData() {
                // Migrate from old format to new normalized schema
                const oldMoods = localStorage.getItem('moods');
                const oldEmotions = localStorage.getItem('emotions');

                if (oldMoods && !localStorage.getItem('therapy_moods')) {
                    console.log('üì¶ Migrating old mood data...');
                    try {
                        const moods = JSON.parse(oldMoods);
                        const normalized = moods.map(m => Schema.Mood.create(m.value, ''));
                        localStorage.setItem('therapy_moods', JSON.stringify(normalized));
                    } catch (error) {
                        console.error('Migration error:', error);
                    }
                }

                if (oldEmotions && !localStorage.getItem('therapy_emotions')) {
                    console.log('üì¶ Migrating old emotion data...');
                    try {
                        const emotions = JSON.parse(oldEmotions);
                        const normalized = emotions.map(e =>
                            Schema.Emotion.create(e.type, e.intensity, {
                                trigger: e.trigger,
                                physical: e.physical,
                                thoughts: e.thoughts,
                                urge: e.urge
                            })
                        );
                        localStorage.setItem('therapy_emotions', JSON.stringify(normalized));
                    } catch (error) {
                        console.error('Migration error:', error);
                    }
                }
            }

            async exportAll() {
                const data = {
                    version: 2,
                    exportDate: new Date().toISOString(),
                    moods: await this.getAll('moods'),
                    emotions: await this.getAll('emotions'),
                    practices: await this.getAll('practices'),
                    sessions: await this.getAll('sessions'),
                    metadata: {
                        lastBackup: await this.getMetadata('lastBackup'),
                        darkMode: await this.getMetadata('darkMode')
                    }
                };
                return data;
            }

            async importAll(data) {
                if (!data.version || data.version < 2) {
                    throw new Error('Formato de backup incompat√≠vel');
                }

                // Clear existing data
                localStorage.removeItem('therapy_moods');
                localStorage.removeItem('therapy_emotions');
                localStorage.removeItem('therapy_practices');
                localStorage.removeItem('therapy_sessions');

                // Import new data
                if (data.moods) localStorage.setItem('therapy_moods', JSON.stringify(data.moods));
                if (data.emotions) localStorage.setItem('therapy_emotions', JSON.stringify(data.emotions));
                if (data.practices) localStorage.setItem('therapy_practices', JSON.stringify(data.practices));
                if (data.sessions) localStorage.setItem('therapy_sessions', JSON.stringify(data.sessions));

                // Import metadata
                if (data.metadata) {
                    for (const [key, value] of Object.entries(data.metadata)) {
                        if (value !== null) await this.setMetadata(key, value);
                    }
                }

                // Sync to IndexedDB
                if (this.ready && this.db) {
                    // Clear IndexedDB stores
                    const stores = ['moods', 'emotions', 'practices', 'sessions'];
                    for (const store of stores) {
                        await this.clearStore(store);
                        const items = data[store] || [];
                        for (const item of items) {
                            await this.saveToIndexedDB(store, item);
                        }
                    }
                }

                return true;
            }

            clearStore(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // ============================================================================
        // APPLICATION STATE
        // ============================================================================

        const App = {
            store: new DataStore(),
            currentMood: null,

            async init() {
                console.log('üöÄ Initializing Therapy App v2...');

                // Initialize data store
                await this.store.init();

                // Load theme
                const darkMode = await this.store.getMetadata('darkMode');
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                }

                // Update UI
                updateDate();
                await this.updateDashboard();
                await this.loadEmotionHistory();
                await this.updateBackupBadge();
                await this.updateStats();

                // Render charts and visualizations
                await this.renderMoodChart(this.currentPeriod);
                await this.updateWeeklyComparison();
                await this.renderEmotionHeatmap();

                // Load practice and session data
                await this.loadPracticeHistory();
                await this.updatePracticeStats();
                await this.loadSessionHistory();

                document.getElementById('dataStatus').textContent =
                    this.store.ready ? '‚úÖ Persist√™ncia ativa' : '‚ö†Ô∏è Apenas localStorage';

                console.log('‚úÖ App initialized');
            },

            async updateDashboard() {
                const today = new Date().toISOString().split('T')[0];
                const moods = await this.store.getAll('moods');
                const emotions = await this.store.getAll('emotions');

                const todayMoods = moods.filter(m => m.date === today);
                const todayEmotions = emotions.filter(e => e.date === today);

                const summary = document.getElementById('todaySummary');
                summary.innerHTML = `
                    <li>Humor: ${todayMoods.length} registro(s)</li>
                    <li>Emo√ß√µes: ${todayEmotions.length} registro(s)</li>
                `;
            },

            async loadEmotionHistory() {
                const emotions = await this.store.getAll('emotions');
                const historyDiv = document.getElementById('emotionHistory');

                if (emotions.length === 0) {
                    historyDiv.innerHTML = '<p>Nenhuma emo√ß√£o registrada ainda.</p>';
                    return;
                }

                const recent = emotions.slice(-10).reverse();
                historyDiv.innerHTML = recent.map(e => `
                    <div class="emotion-log">
                        <div class="note-date">${formatDateTime(e.timestamp)}</div>
                        <strong>${e.type} (Intensidade: ${e.intensity}/10)</strong>
                        ${e.trigger ? `<p><strong>Gatilho:</strong> ${e.trigger}</p>` : ''}
                        ${e.thoughts ? `<p><strong>Pensamentos:</strong> ${e.thoughts}</p>` : ''}
                    </div>
                `).join('');
            },

            async updateBackupBadge() {
                const lastBackup = await this.store.getMetadata('lastBackup');
                const badge = document.getElementById('backupBadge');
                const text = document.getElementById('backupText');

                if (!lastBackup) {
                    text.textContent = 'Backup: nunca';
                    badge.classList.add('warning');
                } else {
                    const days = Math.floor((Date.now() - new Date(lastBackup)) / (1000 * 60 * 60 * 24));
                    text.textContent = `Backup: ${days === 0 ? 'hoje' : days + 'd atr√°s'}`;
                    badge.classList.toggle('warning', days > 7);
                }
            },

            async updateStats() {
                const moods = await this.store.getAll('moods');
                const emotions = await this.store.getAll('emotions');
                const practices = await this.store.getAll('practices');
                const sessions = await this.store.getAll('sessions');

                const statsDiv = document.getElementById('stats');
                statsDiv.innerHTML = `
                    <p><strong>Total de registros:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Humor: ${moods.length}</li>
                        <li>Emo√ß√µes: ${emotions.length}</li>
                        <li>Pr√°ticas: ${practices.length}</li>
                        <li>Sess√µes: ${sessions.length}</li>
                    </ul>
                `;

                const storageInfo = document.getElementById('storageInfo');
                storageInfo.innerHTML = `
                    <p style="margin-top: 10px;">
                        <strong>Status:</strong> ${App.store.ready ?
                            '‚úÖ localStorage + IndexedDB ativo' :
                            '‚ö†Ô∏è Apenas localStorage (IndexedDB indispon√≠vel)'}
                    </p>
                `;
            },

            moodChart: null,
            currentPeriod: 7,

            async renderMoodChart(days = 7) {
                const moods = await this.store.getAll('moods');

                // Get data for the last N days
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - days);

                // Create labels for all days in range
                const labels = [];
                const dataPoints = [];

                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    labels.push(dateStr);

                    // Get average mood for this day
                    const dayMoods = moods.filter(m => m.date === dateStr);
                    if (dayMoods.length > 0) {
                        const avg = dayMoods.reduce((sum, m) => sum + m.value, 0) / dayMoods.length;
                        dataPoints.push(avg.toFixed(1));
                    } else {
                        dataPoints.push(null);
                    }
                }

                // Format labels for display (show day/month)
                const formattedLabels = labels.map(dateStr => {
                    const date = new Date(dateStr);
                    return `${date.getDate()}/${date.getMonth() + 1}`;
                });

                const ctx = document.getElementById('moodChart');
                if (!ctx) return;

                // Destroy existing chart
                if (this.moodChart) {
                    this.moodChart.destroy();
                }

                this.moodChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: formattedLabels,
                        datasets: [{
                            label: 'Humor M√©dio',
                            data: dataPoints,
                            borderColor: '#6b5b95',
                            backgroundColor: 'rgba(107, 91, 149, 0.1)',
                            tension: 0.3,
                            fill: true,
                            spanGaps: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const emojis = ['', 'üòî', 'üòï', 'üòê', 'üôÇ', 'üòä'];
                                        const value = context.parsed.y;
                                        const rounded = Math.round(value);
                                        return `${value} ${emojis[rounded] || ''}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 0,
                                max: 5,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        const emojis = ['', 'üòî', 'üòï', 'üòê', 'üôÇ', 'üòä'];
                                        return emojis[value] || value;
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            },

            async updateWeeklyComparison() {
                const moods = await this.store.getAll('moods');
                const emotions = await this.store.getAll('emotions');

                const today = new Date();

                // Current week (last 7 days)
                const weekStart = new Date(today);
                weekStart.setDate(weekStart.getDate() - 7);

                // Previous week (8-14 days ago)
                const prevWeekStart = new Date(today);
                prevWeekStart.setDate(prevWeekStart.getDate() - 14);
                const prevWeekEnd = new Date(today);
                prevWeekEnd.setDate(prevWeekEnd.getDate() - 8);

                // Calculate current week stats
                const currentWeekMoods = moods.filter(m => {
                    const moodDate = new Date(m.date);
                    return moodDate >= weekStart && moodDate <= today;
                });

                const currentWeekEmotions = emotions.filter(e => {
                    const emotionDate = new Date(e.date);
                    return emotionDate >= weekStart && emotionDate <= today;
                });

                // Calculate previous week stats
                const prevWeekMoods = moods.filter(m => {
                    const moodDate = new Date(m.date);
                    return moodDate >= prevWeekStart && moodDate <= prevWeekEnd;
                });

                const prevWeekEmotions = emotions.filter(e => {
                    const emotionDate = new Date(e.date);
                    return emotionDate >= prevWeekStart && emotionDate <= prevWeekEnd;
                });

                // Calculate averages
                const currentAvg = currentWeekMoods.length > 0
                    ? (currentWeekMoods.reduce((sum, m) => sum + m.value, 0) / currentWeekMoods.length).toFixed(1)
                    : 'N/A';

                const prevAvg = prevWeekMoods.length > 0
                    ? (prevWeekMoods.reduce((sum, m) => sum + m.value, 0) / prevWeekMoods.length).toFixed(1)
                    : 'N/A';

                const moodDelta = currentAvg !== 'N/A' && prevAvg !== 'N/A'
                    ? (currentAvg - prevAvg).toFixed(1)
                    : 'N/A';

                const moodDeltaSymbol = moodDelta > 0 ? 'üìà' : moodDelta < 0 ? 'üìâ' : '‚û°Ô∏è';

                const comparisonDiv = document.getElementById('comparisonStats');
                comparisonDiv.innerHTML = `
                    <p><strong>Humor m√©dio:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li>Semana atual: ${currentAvg} ${moodDeltaSymbol}</li>
                        <li>Semana anterior: ${prevAvg}</li>
                        ${moodDelta !== 'N/A' ? `<li>Diferen√ßa: ${moodDelta > 0 ? '+' : ''}${moodDelta}</li>` : ''}
                    </ul>
                    <p style="margin-top: 10px;"><strong>Registros:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li>Emo√ß√µes esta semana: ${currentWeekEmotions.length}</li>
                        <li>Emo√ß√µes semana anterior: ${prevWeekEmotions.length}</li>
                    </ul>
                `;
            },

            async renderEmotionHeatmap() {
                const emotions = await this.store.getAll('emotions');

                // Get last 7 days
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                // Count emotions by type for each day
                const emotionTypes = ['alegria', 'tristeza', 'raiva', 'medo', 'ansiedade', 'calma', 'frustra√ß√£o', 'esperan√ßa', 'vergonha'];
                const heatmapData = {};

                for (let d = new Date(sevenDaysAgo); d <= today; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    heatmapData[dateStr] = {};

                    emotionTypes.forEach(type => {
                        const count = emotions.filter(e => e.date === dateStr && e.type === type).length;
                        heatmapData[dateStr][type] = count;
                    });
                }

                // Render as simple grid
                const heatmapDiv = document.getElementById('emotionHeatmap');
                let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';

                // Header row (days)
                html += '<tr><th style="padding: 8px; border: 1px solid #ddd;">Emo√ß√£o</th>';
                Object.keys(heatmapData).forEach(dateStr => {
                    const date = new Date(dateStr);
                    html += `<th style="padding: 8px; border: 1px solid #ddd; font-size: 12px;">${date.getDate()}/${date.getMonth() + 1}</th>`;
                });
                html += '</tr>';

                // Data rows (emotions)
                emotionTypes.forEach(type => {
                    html += `<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: 500;">${type}</td>`;
                    Object.values(heatmapData).forEach(dayData => {
                        const count = dayData[type];
                        const intensity = count > 0 ? Math.min(count * 30, 100) : 0;
                        const bgColor = count > 0 ? `rgba(107, 91, 149, ${intensity/100})` : '#f5f5f5';
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: ${bgColor};">${count || ''}</td>`;
                    });
                    html += '</tr>';
                });

                html += '</table></div>';
                html += '<p style="margin-top: 10px; font-size: 12px; color: #666;">Cor mais escura = maior frequ√™ncia</p>';

                heatmapDiv.innerHTML = html;
            },

            async loadPracticeHistory() {
                const practices = await this.store.getAll('practices');
                const historyDiv = document.getElementById('practiceHistory');

                if (practices.length === 0) {
                    historyDiv.innerHTML = '<p>Nenhuma pr√°tica registrada ainda.</p>';
                    return;
                }

                const recent = practices.slice(-10).reverse();
                historyDiv.innerHTML = recent.map(p => `
                    <div class="emotion-log" style="border-left-color: #82ca9d;">
                        <div class="note-date">${formatDateTime(p.timestamp)}</div>
                        <strong>${p.type} - ${p.duration} minutos</strong>
                        ${p.notes ? `<p>${p.notes}</p>` : ''}
                    </div>
                `).join('');
            },

            async updatePracticeStats() {
                const practices = await this.store.getAll('practices');
                const statsDiv = document.getElementById('practiceStats');

                if (practices.length === 0) {
                    statsDiv.innerHTML = '<p>Sem pr√°ticas registradas.</p>';
                    return;
                }

                // Calculate stats
                const totalMinutes = practices.reduce((sum, p) => sum + parseInt(p.duration), 0);
                const avgDuration = (totalMinutes / practices.length).toFixed(1);

                // This month
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const thisMonthPractices = practices.filter(p => new Date(p.date) >= firstDayOfMonth);

                const typeCount = {};
                practices.forEach(p => {
                    typeCount[p.type] = (typeCount[p.type] || 0) + 1;
                });

                const mostCommon = Object.entries(typeCount).sort((a, b) => b[1] - a[1])[0];

                statsDiv.innerHTML = `
                    <p><strong>Estat√≠sticas gerais:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Total de pr√°ticas: ${practices.length}</li>
                        <li>Tempo total: ${totalMinutes} minutos (${(totalMinutes / 60).toFixed(1)}h)</li>
                        <li>Dura√ß√£o m√©dia: ${avgDuration} minutos</li>
                        <li>Pr√°ticas este m√™s: ${thisMonthPractices.length}</li>
                        ${mostCommon ? `<li>Tipo mais praticado: ${mostCommon[0]} (${mostCommon[1]}x)</li>` : ''}
                    </ul>
                `;
            },

            async loadSessionHistory() {
                const sessions = await this.store.getAll('sessions');
                const historyDiv = document.getElementById('sessionHistory');

                if (sessions.length === 0) {
                    historyDiv.innerHTML = '<p>Nenhuma sess√£o registrada ainda.</p>';
                    return;
                }

                const recent = sessions.slice(-5).reverse();
                historyDiv.innerHTML = recent.map(s => `
                    <div class="note-card">
                        <div class="note-date">Sess√£o de ${new Date(s.date).toLocaleDateString('pt-BR')}</div>
                        <p><strong>Resumo:</strong> ${s.summary}</p>
                        ${s.homework ? `<p><strong>Tarefas:</strong> ${s.homework}</p>` : ''}
                        ${s.insights ? `<p><strong>Insights:</strong> ${s.insights}</p>` : ''}
                    </div>
                `).join('');
            }
        };

        // ============================================================================
        // UI FUNCTIONS
        // ============================================================================

        function updateDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent =
                new Date().toLocaleDateString('pt-BR', options);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            App.store.setMetadata('darkMode', document.body.classList.contains('dark-mode'));
        }

        function switchTab(tabName, trigger) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.toggle('active', tab.id === tabName);
            });

            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(nav => nav.classList.remove('active'));

            if (trigger) {
                trigger.classList.add('active');
            }
        }

        function selectMood(value, element) {
            document.querySelectorAll('.mood-emoji').forEach(emoji => {
                emoji.classList.remove('selected');
            });
            element.classList.add('selected');
            App.currentMood = value;
        }

        async function saveMood() {
            if (!App.currentMood) {
                showNotification('Selecione um humor primeiro!', 'error');
                return;
            }

            const note = document.getElementById('moodNote').value;
            const mood = Schema.Mood.create(App.currentMood, note);

            const validation = Schema.Mood.validate(mood);
            if (!validation.valid) {
                showNotification(validation.error, 'error');
                return;
            }

            try {
                await App.store.save('moods', mood);
                showNotification('Humor registrado com sucesso! üéâ', 'success');

                // Clear form
                document.querySelectorAll('.mood-emoji').forEach(e => e.classList.remove('selected'));
                document.getElementById('moodNote').value = '';
                App.currentMood = null;

                // Update all visualizations
                await App.updateDashboard();
                await App.renderMoodChart(App.currentPeriod);
                await App.updateWeeklyComparison();
            } catch (error) {
                showNotification('Erro ao salvar: ' + error.message, 'error');
            }
        }

        async function saveEmotion() {
            const type = document.getElementById('emotionType').value;
            const intensity = document.getElementById('emotionIntensity').value;
            const trigger = document.getElementById('emotionTrigger').value;
            const physical = document.getElementById('physicalSensations').value;
            const thoughts = document.getElementById('emotionThoughts').value;
            const urge = document.getElementById('actionUrge').value;

            const emotion = Schema.Emotion.create(type, intensity, {
                trigger, physical, thoughts, urge
            });

            const validation = Schema.Emotion.validate(emotion);
            if (!validation.valid) {
                showFieldError('emotionType', validation.error);
                return;
            }

            try {
                await App.store.save('emotions', emotion);
                showNotification('Emo√ß√£o registrada com sucesso! üéâ', 'success');

                // Clear form
                document.getElementById('emotionType').value = '';
                document.getElementById('emotionIntensity').value = 5;
                document.getElementById('intensityValue').textContent = '5';
                document.getElementById('emotionTrigger').value = '';
                document.getElementById('physicalSensations').value = '';
                document.getElementById('emotionThoughts').value = '';
                document.getElementById('actionUrge').value = '';
                clearFieldError('emotionType');

                // Update all visualizations
                await App.loadEmotionHistory();
                await App.updateDashboard();
                await App.updateWeeklyComparison();
                await App.renderEmotionHeatmap();
            } catch (error) {
                showNotification('Erro ao salvar: ' + error.message, 'error');
            }
        }

        async function changeMoodPeriod(days) {
            App.currentPeriod = days;
            await App.renderMoodChart(days);
        }

        async function savePractice() {
            const type = document.getElementById('practiceType').value;
            const duration = document.getElementById('practiceDuration').value;
            const notes = document.getElementById('practiceNotes').value;

            const practice = Schema.Practice.create(type, duration, notes);

            const validation = Schema.Practice.validate(practice);
            if (!validation.valid) {
                if (!type) showFieldError('practiceType', validation.error);
                if (!duration) showFieldError('practiceDuration', 'Insira a dura√ß√£o');
                return;
            }

            try {
                await App.store.save('practices', practice);
                showNotification('Pr√°tica registrada com sucesso! üéâ', 'success');

                // Clear form
                document.getElementById('practiceType').value = '';
                document.getElementById('practiceDuration').value = '';
                document.getElementById('practiceNotes').value = '';
                clearFieldError('practiceType');
                clearFieldError('practiceDuration');

                await App.loadPracticeHistory();
                await App.updatePracticeStats();
            } catch (error) {
                showNotification('Erro ao salvar: ' + error.message, 'error');
            }
        }

        async function saveSession() {
            const date = document.getElementById('sessionDate').value;
            const summary = document.getElementById('sessionSummary').value;
            const homework = document.getElementById('sessionHomework').value;
            const insights = document.getElementById('sessionInsights').value;

            const session = Schema.Session.create(date, summary, homework, insights);

            const validation = Schema.Session.validate(session);
            if (!validation.valid) {
                if (!date) showFieldError('sessionDate', validation.error);
                if (!summary) showFieldError('sessionSummary', 'Adicione um resumo');
                return;
            }

            try {
                await App.store.save('sessions', session);
                showNotification('Sess√£o salva com sucesso! üéâ', 'success');

                // Clear form
                document.getElementById('sessionDate').value = '';
                document.getElementById('sessionSummary').value = '';
                document.getElementById('sessionHomework').value = '';
                document.getElementById('sessionInsights').value = '';
                clearFieldError('sessionDate');
                clearFieldError('sessionSummary');

                await App.loadSessionHistory();
                await App.updateStats();
            } catch (error) {
                showNotification('Erro ao salvar: ' + error.message, 'error');
            }
        }

        async function exportBackup() {
            try {
                const data = await App.store.exportAll();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `therapy-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                await App.store.setMetadata('lastBackup', new Date().toISOString());
                await App.updateBackupBadge();

                showNotification('Backup baixado com sucesso!', 'success');
            } catch (error) {
                showNotification('Erro ao exportar: ' + error.message, 'error');
            }
        }

        async function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (!confirm('‚ö†Ô∏è Isso ir√° substituir todos os dados atuais. Continuar?')) {
                    return;
                }

                await App.store.importAll(data);
                showNotification('Backup restaurado com sucesso!', 'success');

                // Reload all data
                await App.updateDashboard();
                await App.loadEmotionHistory();
                await App.updateStats();
                await App.updateBackupBadge();
            } catch (error) {
                showNotification('Erro ao restaurar: ' + error.message, 'error');
            }
        }

        function showBackupModal() {
            if (confirm('Deseja fazer backup agora?')) {
                exportBackup();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(fieldId + 'Error');

            field.classList.add('error');
            if (error) {
                error.textContent = message;
                error.classList.add('visible');
            }
        }

        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(fieldId + 'Error');

            field.classList.remove('error');
            if (error) {
                error.classList.remove('visible');
            }
        }

        function formatDateTime(isoString) {
            return new Date(isoString).toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Update intensity display
        document.addEventListener('DOMContentLoaded', () => {
            const intensitySlider = document.getElementById('emotionIntensity');
            if (intensitySlider) {
                intensitySlider.addEventListener('input', function() {
                    document.getElementById('intensityValue').textContent = this.value;
                });
            }
        });

        // Initialize app on load
        window.onload = () => {
            App.init();
        };
    </script>
</body>
</html>
