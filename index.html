<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Espa√ßo Terap√™utico - DBT v2</title>

    <!-- Google Analytics 4 -->
    <!-- INSTRU√á√ÉO: Substitua 'G-XXXXXXXXXX' pelo seu ID real do Google Analytics 4 -->
    <!-- Para criar: https://analytics.google.com ‚Üí Admin ‚Üí Create Property ‚Üí Data Streams -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        // Configura√ß√£o b√°sica do GA4
        gtag('config', 'G-XXXXXXXXXX', {
            'cookie_flags': 'SameSite=None;Secure', // LGPD compliance
            'anonymize_ip': true // Anonimizar IPs para privacidade
        });

        // Helper function para trackear eventos customizados
        window.trackEvent = function(eventName, properties = {}) {
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, properties);
                console.log('üìä Analytics Event:', eventName, properties);
            }
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6b5b95;
            --secondary: #88b0d3;
            --accent: #ffb447;
            --success: #82ca9d;
            --danger: #f67280;
            --bg-light: #f8f9fa;
            --bg-dark: #1a1a2e;
            --text-light: #333;
            --text-dark: #f0f0f0;
            --card-light: #ffffff;
            --card-dark: #16213e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .dark-mode .header {
            background: rgba(22, 33, 62, 0.95);
            color: var(--text-dark);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .logo h1 {
            font-size: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .backup-badge {
            background: rgba(130, 202, 157, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--success);
            cursor: pointer;
            transition: all 0.3s;
        }

        .backup-badge:hover {
            background: rgba(130, 202, 157, 0.4);
        }

        .backup-badge.warning {
            background: rgba(246, 114, 128, 0.2);
            color: var(--danger);
        }

        .theme-toggle {
            width: 50px;
            height: 26px;
            background: var(--secondary);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle::after {
            content: 'üåû';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s;
        }

        .dark-mode .theme-toggle::after {
            transform: translateX(24px);
            content: 'üåô';
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .nav-tabs {
            background: rgba(22, 33, 62, 0.9);
        }

        .nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: rgba(107, 91, 149, 0.1);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            min-height: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .content-area {
            background: rgba(22, 33, 62, 0.95);
            color: var(--text-dark);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .dashboard-card {
            background: linear-gradient(135deg, #2d3561 0%, #1e2749 100%);
        }

        .mood-tracker {
            text-align: center;
        }

        .mood-scale {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .mood-emoji {
            font-size: 35px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 10px;
            border-radius: 10px;
        }

        .mood-emoji:hover {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.3);
        }

        .mood-emoji.selected {
            background: var(--accent);
            transform: scale(1.1);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary);
        }

        .dark-mode label {
            color: var(--secondary);
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .dark-mode input,
        .dark-mode textarea,
        .dark-mode select {
            background: var(--bg-dark);
            color: var(--text-dark);
            border-color: #3a3a3a;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(107, 91, 149, 0.1);
        }

        input.error, textarea.error, select.error {
            border-color: var(--danger);
        }

        .field-error {
            color: var(--danger);
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .field-error.visible {
            display: block;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(107, 91, 149, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-danger {
            background: var(--danger);
        }

        .period-btn {
            padding: 8px 16px;
            margin-right: 5px;
            background: rgba(136, 176, 211, 0.2);
            border: 2px solid var(--secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .period-btn:hover {
            background: var(--secondary);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        .dark-mode .modal-content {
            background: var(--card-dark);
            color: var(--text-dark);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        /* Emotion history */
        .emotion-log {
            background: rgba(255, 255, 255, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
        }

        .dark-mode .emotion-log {
            background: rgba(0, 0, 0, 0.3);
        }

        .note-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .nav-tabs {
                justify-content: center;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            animation: slideIn 0.3s;
            max-width: 300px;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Routine Config Styles */
        .activity-config-item {
            background: rgba(255, 255, 255, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
        }

        .dark-mode .activity-config-item {
            background: rgba(0, 0, 0, 0.3);
        }

        .activity-config-item input[type="time"],
        .activity-config-item input[type="text"] {
            width: 100%;
            margin-bottom: 8px;
        }

        .activity-config-controls {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .activity-config-controls button {
            padding: 6px 12px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .activity-config-controls .btn-move {
            background: var(--secondary);
            color: white;
        }

        .activity-config-controls .btn-remove {
            background: var(--danger);
            color: white;
        }

        .activity-config-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* ============================================================================
           ONBOARDING MODAL STYLES
           ============================================================================ */

        .onboarding-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .onboarding-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s;
        }

        .onboarding-container {
            background: white;
            border-radius: 25px;
            padding: 50px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .dark-mode .onboarding-container {
            background: var(--card-dark);
            color: var(--text-dark);
        }

        .onboarding-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 10px;
        }

        .progress-step {
            flex: 1;
            height: 6px;
            background: rgba(107, 91, 149, 0.2);
            border-radius: 3px;
            transition: all 0.3s;
        }

        .progress-step.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .onboarding-step {
            display: none;
            animation: fadeIn 0.5s;
        }

        .onboarding-step.active {
            display: block;
        }

        .onboarding-title {
            font-size: 32px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .onboarding-description {
            font-size: 16px;
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .dark-mode .onboarding-description {
            color: #ccc;
        }

        .onboarding-content {
            min-height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
        }

        .onboarding-controls {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }

        .onboarding-controls .btn {
            flex: 1;
            max-width: 180px;
        }

        .btn-skip {
            background: transparent;
            color: #999;
            border: 2px solid #999;
        }

        .btn-skip:hover {
            background: #999;
            color: white;
        }

        @media (max-width: 768px) {
            .onboarding-container {
                padding: 30px 20px;
                width: 95%;
            }

            .onboarding-title {
                font-size: 24px;
            }

            .onboarding-description {
                font-size: 14px;
            }

            .onboarding-controls {
                flex-direction: column;
            }

            .onboarding-controls .btn {
                max-width: 100%;
            }
        }

        /* Dark Green Theme for New Pages */
        :root {
            --dark-bg: #0a1e1e;
            --dark-card: #162e2e;
            --dark-sidebar: #1a2f2f;
            --green-primary: #4ade80;
            --green-accent: #22c55e;
            --dark-text: #e0e0e0;
            --dark-text-secondary: #a0a0a0;
            --dark-border: #2a3f3f;
        }

        /* Sidebar Layout for Settings/Profile */
        .settings-container {
            display: flex;
            gap: 30px;
            min-height: 600px;
        }

        .settings-sidebar {
            min-width: 250px;
            background: var(--dark-sidebar);
            padding: 30px 0;
            border-radius: 15px;
            height: fit-content;
        }

        .sidebar-profile {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--dark-border);
            text-align: center;
        }

        .sidebar-profile-pic {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 10px;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .sidebar-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--dark-text-secondary);
        }

        .sidebar-item:hover {
            background: rgba(74, 222, 128, 0.1);
            color: var(--green-primary);
        }

        .sidebar-item.active {
            background: rgba(74, 222, 128, 0.15);
            color: var(--green-primary);
            border-left: 3px solid var(--green-primary);
        }

        .settings-content {
            flex: 1;
            background: var(--dark-card);
            padding: 40px;
            border-radius: 15px;
        }

        /* Calendar Component */
        .calendar-container {
            background: var(--dark-card);
            border-radius: 15px;
            padding: 20px;
            max-width: 400px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: none;
            border: none;
            color: var(--dark-text);
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .calendar-nav:hover {
            background: rgba(74, 222, 128, 0.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            text-align: center;
        }

        #calendarDays, #journalCalendarDays {
            display: contents;
        }

        .calendar-day-header {
            font-size: 12px;
            color: var(--dark-text-secondary);
            padding: 8px 0;
            font-weight: 600;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            position: relative;
        }

        .calendar-day:hover {
            background: rgba(74, 222, 128, 0.1);
        }

        .calendar-day.today {
            border: 2px solid var(--green-primary);
        }

        .calendar-day.has-entry {
            background: var(--green-primary);
            color: var(--dark-bg);
            font-weight: bold;
        }

        .calendar-day.other-month {
            color: var(--dark-text-secondary);
            opacity: 0.3;
        }

        /* Insights Page Styles */
        .insights-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .insights-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .insights-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            background: var(--dark-card);
            padding: 8px;
            border-radius: 10px;
            width: fit-content;
        }

        .period-option {
            padding: 8px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--dark-text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .period-option.active {
            background: var(--green-primary);
            color: var(--dark-bg);
        }

        .stat-card {
            background: var(--dark-card);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: rgba(74, 222, 128, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 24px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--dark-text-secondary);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--dark-text);
        }

        /* Resources Page */
        .resources-header {
            margin-bottom: 30px;
        }

        .search-bar {
            width: 100%;
            padding: 15px 20px;
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 12px;
            color: var(--dark-text);
            font-size: 16px;
            margin-bottom: 20px;
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--green-primary);
        }

        .resource-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-tag {
            padding: 10px 20px;
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 8px;
            color: var(--dark-text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-tag.active {
            background: var(--green-primary);
            color: var(--dark-bg);
            border-color: var(--green-primary);
        }

        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .resource-card {
            background: var(--dark-card);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid var(--dark-border);
            transition: all 0.3s;
            cursor: pointer;
        }

        .resource-card:hover {
            border-color: var(--green-primary);
            transform: translateY(-5px);
        }

        .resource-icon {
            width: 48px;
            height: 48px;
            background: rgba(74, 222, 128, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .resource-category {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(74, 222, 128, 0.2);
            color: var(--green-primary);
            border-radius: 6px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .resource-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 10px;
        }

        .resource-description {
            font-size: 14px;
            color: var(--dark-text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .resource-duration {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--dark-text-secondary);
            font-size: 13px;
        }

        /* Journal Entry */
        .journal-editor {
            background: var(--dark-card);
            border-radius: 15px;
            padding: 30px;
            min-height: 400px;
        }

        .journal-prompt {
            font-size: 32px;
            font-weight: 300;
            color: var(--dark-text);
            margin-bottom: 30px;
        }

        .journal-textarea {
            width: 100%;
            min-height: 300px;
            background: transparent;
            border: none;
            color: var(--dark-text);
            font-size: 16px;
            line-height: 1.8;
            resize: vertical;
            font-family: inherit;
        }

        .journal-textarea:focus {
            outline: none;
        }

        .journal-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--dark-border);
        }

        .journal-meta {
            color: var(--dark-text-secondary);
            font-size: 13px;
        }

        .journal-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .journal-entry-card {
            background: var(--dark-card);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--green-primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .journal-entry-card:hover {
            transform: translateX(5px);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .entry-date {
            font-weight: 600;
            color: var(--dark-text);
        }

        .entry-mood {
            font-size: 20px;
        }

        .entry-preview {
            color: var(--dark-text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }

        /* Export Button */
        .export-btn {
            position: fixed;
            top: 80px;
            right: 30px;
            background: var(--green-primary);
            color: var(--dark-bg);
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            z-index: 100;
        }

        .export-btn:hover {
            background: var(--green-accent);
            transform: translateY(-2px);
        }

        /* Profile Section */
        .profile-section {
            background: var(--dark-card);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .profile-picture {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
        }

        .btn-delete {
            background: transparent;
            border: 2px solid #ef4444;
            color: #ef4444;
        }

        .btn-delete:hover {
            background: #ef4444;
            color: white;
        }

        .btn-upload {
            background: var(--green-primary);
            color: var(--dark-bg);
        }

        .btn-upload:hover {
            background: var(--green-accent);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-cancel {
            background: transparent;
            border: 2px solid var(--dark-border);
            color: var(--dark-text-secondary);
        }

        .btn-cancel:hover {
            background: var(--dark-border);
            color: var(--dark-text);
        }

        .btn-save {
            background: var(--green-primary);
            color: var(--dark-bg);
        }

        .btn-save:hover {
            background: var(--green-accent);
        }

        @media (max-width: 1024px) {
            .insights-grid {
                grid-template-columns: 1fr;
            }

            .settings-container {
                flex-direction: column;
            }

            .settings-sidebar {
                min-width: 100%;
            }

            .resource-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">üå±</div>
                <div>
                    <h1>Meu Espa√ßo Terap√™utico v2</h1>
                    <small id="dataStatus">Carregando...</small>
                </div>
            </div>
            <div class="header-controls">
                <div class="backup-badge" id="backupBadge" onclick="showBackupModal()">
                    <span id="backupText">√öltimo backup: nunca</span>
                </div>
                <span id="currentDate"></span>
                <div class="theme-toggle" onclick="toggleTheme()"></div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard" onclick="switchTab('dashboard', this)">
                <span>üìä</span> Dashboard
            </button>
            <button class="nav-tab" data-tab="insights" onclick="switchTab('insights', this)">
                <span>üìà</span> Insights
            </button>
            <button class="nav-tab" data-tab="journal" onclick="switchTab('journal', this)">
                <span>üìî</span> Journal
            </button>
            <button class="nav-tab" data-tab="emotions" onclick="switchTab('emotions', this)">
                <span>üí≠</span> Emo√ß√µes
            </button>
            <button class="nav-tab" data-tab="routine" onclick="switchTab('routine', this)">
                <span>üìÖ</span> Rotina
            </button>
            <button class="nav-tab" data-tab="mindfulness" onclick="switchTab('mindfulness', this)">
                <span>üßò</span> Mindfulness
            </button>
            <button class="nav-tab" data-tab="resources" onclick="switchTab('resources', this)">
                <span>üåø</span> Resources
            </button>
            <button class="nav-tab" data-tab="skills" onclick="switchTab('skills', this)">
                <span>üõ†Ô∏è</span> Habilidades
            </button>
            <button class="nav-tab" data-tab="sessions" onclick="switchTab('sessions', this)">
                <span>üìù</span> Sess√µes
            </button>
            <button class="nav-tab" data-tab="settings" onclick="switchTab('settings', this)">
                <span>‚öôÔ∏è</span> Configura√ß√µes
            </button>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <!-- Quick Mood Registration Card -->
                <div class="dashboard-card mood-tracker" style="margin-bottom: 30px;">
                    <h2 style="margin-bottom: 20px; text-align: center;">Como voc√™ est√° hoje?</h2>
                    <div class="mood-scale">
                        <span class="mood-emoji" onclick="saveMoodQuick(1)" title="Muito mal">üòî</span>
                        <span class="mood-emoji" onclick="saveMoodQuick(2)" title="Mal">üòï</span>
                        <span class="mood-emoji" onclick="saveMoodQuick(3)" title="Neutro">üòê</span>
                        <span class="mood-emoji" onclick="saveMoodQuick(4)" title="Bem">üôÇ</span>
                        <span class="mood-emoji" onclick="saveMoodQuick(5)" title="Muito bem">üòä</span>
                    </div>
                    <p style="text-align: center; margin-top: 15px; font-size: 13px; color: #666;">
                        üí° Clique no emoji para registrar rapidamente
                        <button class="btn" style="padding: 6px 12px; margin-left: 10px; font-size: 13px;" onclick="showDetailedMoodForm()">
                            Adicionar nota
                        </button>
                    </p>
                    <div id="detailedMoodForm" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <div class="form-group">
                            <label>Escolha seu humor:</label>
                            <div class="mood-scale">
                                <span class="mood-emoji" onclick="selectMood(1, this)" title="Muito mal">üòî</span>
                                <span class="mood-emoji" onclick="selectMood(2, this)" title="Mal">üòï</span>
                                <span class="mood-emoji" onclick="selectMood(3, this)" title="Neutro">üòê</span>
                                <span class="mood-emoji" onclick="selectMood(4, this)" title="Bem">üôÇ</span>
                                <span class="mood-emoji" onclick="selectMood(5, this)" title="Muito bem">üòä</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Notas (opcional):</label>
                            <textarea id="moodNote" rows="2" placeholder="O que est√° acontecendo?"></textarea>
                        </div>
                        <button class="btn btn-success" onclick="saveMood()">Registrar com Nota</button>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <!-- Insight Card (Will be populated by A2) -->
                    <div class="dashboard-card" id="insightCard" style="border-left: 4px solid var(--accent);">
                        <h3>üí° Insight da Semana</h3>
                        <p style="margin-top: 10px; font-size: 15px;" id="insightText">
                            Continue registrando seu humor para receber insights personalizados.
                        </p>
                    </div>

                    <!-- Mood Average Card -->
                    <div class="dashboard-card" style="border-left: 4px solid var(--primary);">
                        <h3>üìà Humor da Semana</h3>
                        <div id="weekMoodSummary" style="margin-top: 15px;">
                            <p style="font-size: 28px; font-weight: bold; text-align: center;" id="weekMoodAvg">-</p>
                            <p style="text-align: center; color: #666; font-size: 14px;" id="weekMoodChange">Sem dados ainda</p>
                        </div>
                    </div>
                </div>

                <!-- Mood Chart -->
                <div class="dashboard-card" id="moodChartCard" style="margin-top: 20px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h3>Tend√™ncia de Humor</h3>
                        <div>
                            <button class="period-btn" onclick="changeMoodPeriod(7)">7 dias</button>
                            <button class="period-btn" onclick="changeMoodPeriod(30)">30 dias</button>
                        </div>
                    </div>
                    <canvas id="moodChart" style="max-height: 350px;"></canvas>
                </div>

                <!-- Empty State Placeholder (Enhanced - TASK-009) -->
                <div class="dashboard-card" id="emptyStatePlaceholder" style="margin-top: 20px; text-align: center; padding: 50px 20px; display: none;">
                    <!-- Illustration SVG -->
                    <div style="margin-bottom: 25px;">
                        <svg width="200" height="150" viewBox="0 0 200 150" style="margin: 0 auto;">
                            <!-- Simple meditation person illustration -->
                            <circle cx="100" cy="50" r="25" fill="var(--primary)" opacity="0.3"/>
                            <ellipse cx="100" cy="100" rx="40" ry="30" fill="var(--secondary)" opacity="0.2"/>
                            <path d="M70 90 Q100 80 130 90" stroke="var(--primary)" stroke-width="3" fill="none"/>
                            <text x="100" y="140" text-anchor="middle" font-size="40" fill="var(--accent)">üßò</text>
                        </svg>
                    </div>

                    <h3 style="margin-bottom: 15px; font-size: 24px; color: var(--primary);">
                        Sua jornada come√ßa aqui! üå±
                    </h3>
                    <p style="color: #666; margin-bottom: 30px; line-height: 1.6;">
                        Registre seu primeiro humor acima para come√ßar a acompanhar<br>sua jornada de auto-conhecimento e regula√ß√£o emocional.
                    </p>

                    <!-- Pr√≥ximos Passos Card -->
                    <div style="background: linear-gradient(135deg, rgba(107, 91, 149, 0.1), rgba(136, 176, 211, 0.1)); padding: 25px; border-radius: 15px; max-width: 500px; margin: 0 auto; text-align: left;">
                        <h4 style="margin-bottom: 15px; text-align: center; color: var(--primary);">
                            üìù Pr√≥ximos Passos
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <a href="javascript:void(0)" onclick="document.querySelector('.mood-emoji').scrollIntoView({behavior: 'smooth', block: 'center'})" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border-radius: 8px; text-decoration: none; color: inherit; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                                <span style="font-size: 24px;">‚úÖ</span>
                                <div>
                                    <strong style="display: block; margin-bottom: 3px;">Registrar humor</strong>
                                    <small style="color: #666;">Comece clicando em um emoji acima</small>
                                </div>
                            </a>
                            <a href="javascript:void(0)" onclick="switchTab('skills', document.querySelector('[data-tab=skills]'))" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border-radius: 8px; text-decoration: none; color: inherit; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                                <span style="font-size: 24px;">üìö</span>
                                <div>
                                    <strong style="display: block; margin-bottom: 3px;">Explorar habilidades DBT</strong>
                                    <small style="color: #666;">Aprenda t√©cnicas de regula√ß√£o emocional</small>
                                </div>
                            </a>
                            <a href="javascript:void(0)" onclick="switchTab('configuracoes', document.querySelector('[data-tab=configuracoes]'))" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border-radius: 8px; text-decoration: none; color: inherit; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                                <span style="font-size: 24px;">‚è∞</span>
                                <div>
                                    <strong style="display: block; margin-bottom: 3px;">Configurar lembrete</strong>
                                    <small style="color: #666;">Mantenha sua pr√°tica consistente</small>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Progress State (< 7 registros) -->
                <div class="dashboard-card" id="progressState" style="margin-top: 20px; text-align: center; padding: 30px; background: linear-gradient(135deg, rgba(130, 202, 157, 0.1), rgba(136, 176, 211, 0.1)); border-left: 4px solid var(--success); display: none;">
                    <h3 style="margin-bottom: 10px; color: var(--success);">
                        üéØ Voc√™ est√° no caminho certo!
                    </h3>
                    <p style="font-size: 18px; margin-bottom: 15px; color: #555;" id="progressText">
                        Voc√™ tem <strong id="recordCount">0</strong> registros. Continue assim!
                    </p>
                    <div style="background: white; padding: 15px; border-radius: 10px; max-width: 400px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px;">
                            <span>Progresso:</span>
                            <span><strong id="progressPercentage">0%</strong> para insights completos</span>
                        </div>
                        <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div id="progressBar" style="background: linear-gradient(90deg, var(--primary), var(--success)); height: 100%; width: 0%; transition: width 0.5s;"></div>
                        </div>
                        <p style="margin-top: 10px; font-size: 13px; color: #888;">
                            üí° 7 registros necess√°rios para insights personalizados
                        </p>
                    </div>
                </div>

                <!-- Top 3 Emotions (Will be implemented in A1) -->
                <div class="dashboard-card" id="top3EmotionsCard" style="margin-top: 20px; display: none;">
                    <h3>üé≠ Top 3 Emo√ß√µes (7 dias)</h3>
                    <div id="top3Emotions" style="margin-top: 15px;">
                        <!-- Will be populated by A1 -->
                    </div>
                </div>
            </div>

            <!-- Insights Tab -->
            <div id="insights" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h2 style="margin: 0;">Your Detailed Insights</h2>
                        <p style="color: var(--dark-text-secondary); margin-top: 5px;">Explore your emotional trends and patterns over time.</p>
                    </div>
                    <button class="export-btn" onclick="exportPDF()" style="position: static;">
                        <span>üìÑ</span> Export Data
                    </button>
                </div>

                <div class="period-selector" style="margin-bottom: 30px;">
                    <button class="period-option active" onclick="changePeriod('week', this)">Week</button>
                    <button class="period-option" onclick="changePeriod('month', this)">Month</button>
                    <button class="period-option" onclick="changePeriod('year', this)">Year</button>
                </div>

                <div class="insights-grid">
                    <!-- Left Sidebar -->
                    <div class="insights-sidebar">
                        <!-- Calendar -->
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button class="calendar-nav" onclick="prevMonth()">‚óÄ</button>
                                <h3 id="calendarMonth">October 2023</h3>
                                <button class="calendar-nav" onclick="nextMonth()">‚ñ∂</button>
                            </div>
                            <div class="calendar-grid">
                                <div class="calendar-day-header">S</div>
                                <div class="calendar-day-header">M</div>
                                <div class="calendar-day-header">T</div>
                                <div class="calendar-day-header">W</div>
                                <div class="calendar-day-header">T</div>
                                <div class="calendar-day-header">F</div>
                                <div class="calendar-day-header">S</div>
                                <!-- Calendar days will be rendered here -->
                                <div id="calendarDays"></div>
                            </div>
                        </div>

                        <!-- Weekly Summary Stats -->
                        <div class="dashboard-card" style="background: var(--dark-card); color: var(--dark-text);">
                            <h3 style="margin-bottom: 20px; text-align: center;">Humor da Semana</h3>
                            <p style="color: var(--dark-text-secondary); margin-bottom: 15px; text-align: center; font-size: 14px;">Your mood fluctuations over the selected period.</p>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px;">
                                <div class="stat-card">
                                    <div style="font-size: 28px; margin-bottom: 5px;">üòä</div>
                                    <div class="stat-label">Most Frequent</div>
                                    <div class="stat-value" id="mostFrequentEmotion">Happy</div>
                                </div>
                                <div class="stat-card">
                                    <div style="font-size: 28px; margin-bottom: 5px;">üìä</div>
                                    <div class="stat-label">Average Mood</div>
                                    <div class="stat-value" id="averageMood">4.2 / 5</div>
                                </div>
                                <div class="stat-card">
                                    <div style="font-size: 28px; margin-bottom: 5px;">üî•</div>
                                    <div class="stat-label">Longest Streak</div>
                                    <div class="stat-value" id="longestStreak">5 Days</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="insights-main">
                        <!-- Mood Trends Chart -->
                        <div class="dashboard-card" style="background: var(--dark-card); color: var(--dark-text);">
                            <h3 style="margin-bottom: 20px;">Mood Trends Over Time</h3>
                            <p style="color: var(--dark-text-secondary); margin-bottom: 20px; font-size: 14px;">Daily emotional fluctuations for the selected week.</p>
                            <canvas id="insightsMoodChart" style="max-height: 300px;"></canvas>
                        </div>

                        <!-- Key Emotional Patterns & Charts -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Emotional Patterns -->
                            <div class="dashboard-card" style="background: var(--dark-card); color: var(--dark-text);">
                                <h3 style="margin-bottom: 20px;">Key Emotional Patterns</h3>
                                <p style="color: var(--dark-text-secondary); margin-bottom: 20px; font-size: 14px;">A summary of your emotional landscape for this period.</p>
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <div class="stat-card" style="text-align: left; display: flex; align-items: center; gap: 15px;">
                                        <div class="stat-icon">üòä</div>
                                        <div style="flex: 1;">
                                            <div class="stat-label">Most Frequent Emotion</div>
                                            <div class="stat-value">Joy</div>
                                        </div>
                                    </div>
                                    <div class="stat-card" style="text-align: left; display: flex; align-items: center; gap: 15px;">
                                        <div class="stat-icon">üìà</div>
                                        <div style="flex: 1;">
                                            <div class="stat-label">Average Mood</div>
                                            <div class="stat-value">4.2 / 5 (Positive)</div>
                                        </div>
                                    </div>
                                    <div class="stat-card" style="text-align: left; display: flex; align-items: center; gap: 15px;">
                                        <div class="stat-icon">üïê</div>
                                        <div style="flex: 1;">
                                            <div class="stat-label">Most Common Time</div>
                                            <div class="stat-value">Mornings (8-11 AM)</div>
                                        </div>
                                    </div>
                                    <div class="stat-card" style="text-align: left; display: flex; align-items: center; gap: 15px;">
                                        <div class="stat-icon">üíº</div>
                                        <div style="flex: 1;">
                                            <div class="stat-label">Common Trigger</div>
                                            <div class="stat-value">Work</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Emotional Intensity Donut Chart -->
                            <div class="dashboard-card" style="background: var(--dark-card); color: var(--dark-text);">
                                <h3 style="margin-bottom: 20px;">Emotional Intensity</h3>
                                <p style="color: var(--dark-text-secondary); margin-bottom: 20px; font-size: 14px;">Distribution of emotional intensity levels.</p>
                                <canvas id="emotionalIntensityChart" style="max-height: 250px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Entries -->
                <div class="dashboard-card" style="background: var(--dark-card); color: var(--dark-text); margin-top: 30px;">
                    <h3 style="margin-bottom: 20px;">Recent Entries</h3>
                    <div id="recentEntriesList" style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Journal Tab -->
            <div id="journal" class="tab-content">
                <div style="display: flex; gap: 30px;">
                    <!-- Left Sidebar - Calendar & Entries -->
                    <div style="min-width: 300px;">
                        <h2 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 32px;">üåø</span>
                            <div>
                                <div>My Journal</div>
                                <small style="font-size: 14px; font-weight: normal; color: var(--dark-text-secondary);">Reflect and Grow</small>
                            </div>
                        </h2>

                        <!-- Calendar -->
                        <div class="calendar-container" style="margin-bottom: 20px;">
                            <div class="calendar-header">
                                <button class="calendar-nav" onclick="journalPrevMonth()">‚óÄ</button>
                                <h3 id="journalCalendarMonth">October 2023</h3>
                                <button class="calendar-nav" onclick="journalNextMonth()">‚ñ∂</button>
                            </div>
                            <div class="calendar-grid">
                                <div class="calendar-day-header">S</div>
                                <div class="calendar-day-header">M</div>
                                <div class="calendar-day-header">T</div>
                                <div class="calendar-day-header">W</div>
                                <div class="calendar-day-header">T</div>
                                <div class="calendar-day-header">F</div>
                                <div class="calendar-day-header">S</div>
                                <div id="journalCalendarDays"></div>
                            </div>
                        </div>

                        <!-- Recent Entries -->
                        <div class="dashboard-card" style="background: var(--dark-sidebar); color: var(--dark-text); padding: 15px;">
                            <h4 style="margin: 0 0 15px 0; font-size: 14px; text-transform: uppercase; color: var(--dark-text-secondary);">October 2023</h4>
                            <div class="journal-list">
                                <div class="journal-entry-card" onclick="loadJournalEntry('2023-10-26')">
                                    <div class="entry-header">
                                        <div class="entry-date">October 26</div>
                                        <div class="entry-mood">üòä</div>
                                    </div>
                                    <div class="entry-preview">Today was a really good day. I managed to fi...</div>
                                </div>
                                <div class="journal-entry-card" onclick="loadJournalEntry('2023-10-25')">
                                    <div class="entry-header">
                                        <div class="entry-date">October 25</div>
                                        <div class="entry-mood">üòî</div>
                                    </div>
                                    <div class="entry-preview">Feeling a bit down today. It's been raining all...</div>
                                </div>
                                <div class="journal-entry-card" onclick="loadJournalEntry('2023-10-24')">
                                    <div class="entry-header">
                                        <div class="entry-date">October 24</div>
                                        <div class="entry-mood">üò£</div>
                                    </div>
                                    <div class="entry-preview">Work was incredibly stressful. So many dea...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Editor -->
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h3 style="margin: 0; color: var(--dark-text-secondary);">October 2023 / <span style="color: var(--dark-text);">October 26</span></h3>
                            </div>
                            <div style="display: flex; gap: 15px;">
                                <button class="btn" style="padding: 8px 16px; background: transparent; border: 2px solid var(--dark-border); color: var(--dark-text-secondary);">
                                    üòä
                                </button>
                                <button class="btn" style="padding: 8px 16px; background: transparent; border: 2px solid var(--dark-border); color: var(--dark-text-secondary);">
                                    üíæ
                                </button>
                                <button class="btn" style="padding: 8px 16px; background: transparent; border: 2px solid var(--dark-border); color: var(--dark-text-secondary);">
                                    üîí
                                </button>
                                <button class="btn btn-save" onclick="saveJournalEntry()" style="padding: 8px 24px;">
                                    Save
                                </button>
                            </div>
                        </div>

                        <div class="journal-editor">
                            <div class="journal-prompt">What's on your mind today?</div>
                            <textarea
                                class="journal-textarea"
                                id="journalTextarea"
                                placeholder="Let it all out..."></textarea>
                            <div class="journal-toolbar">
                                <div class="journal-meta">Auto-saved a few seconds ago</div>
                                <div class="journal-meta" id="journalWordCount">0 words</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resources Tab -->
            <div id="resources" class="tab-content">
                <div class="resources-header">
                    <h2 style="margin: 0 0 10px 0;">Tools & Resources for Your Well-being</h2>
                    <p style="color: var(--dark-text-secondary); margin-bottom: 25px;">Explore a collection of resources to support your journey.</p>

                    <input type="text" class="search-bar" placeholder="üîç Search for tools, articles, meditations..." id="resourceSearch">

                    <div class="resource-filters">
                        <button class="filter-tag active" onclick="filterResources('all', this)">All</button>
                        <button class="filter-tag" onclick="filterResources('meditations', this)">Meditations</button>
                        <button class="filter-tag" onclick="filterResources('articles', this)">Articles</button>
                        <button class="filter-tag" onclick="filterResources('exercises', this)">Exercises</button>
                        <button class="filter-tag" onclick="filterResources('techniques', this)">Techniques</button>
                    </div>
                </div>

                <!-- Featured Resource -->
                <div class="dashboard-card" style="background: linear-gradient(135deg, var(--dark-card) 0%, var(--dark-sidebar) 100%); color: var(--dark-text); padding: 40px; margin-bottom: 30px;">
                    <div class="resource-category">Guided Meditation</div>
                    <h2 style="margin: 15px 0; font-size: 32px;">Mindful Morning Meditation</h2>
                    <p style="color: var(--dark-text-secondary); margin-bottom: 25px; max-width: 600px; line-height: 1.6;">Start your day with calm and clarity. This 10-minute guided session helps you set a positive tone for the hours ahead.</p>
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <button class="btn btn-upload" style="padding: 12px 30px; font-size: 16px;">
                            ‚ñ∂ Begin Session
                        </button>
                        <div style="display: flex; align-items: center; gap: 8px; color: var(--dark-text-secondary);">
                            <span>üïê</span>
                            <span>10 min</span>
                        </div>
                    </div>
                </div>

                <!-- Resources Grid -->
                <div class="resource-grid" id="resourcesGrid">
                    <!-- Breathing Exercise -->
                    <div class="resource-card" data-category="exercises">
                        <div class="resource-icon">ü´Å</div>
                        <div class="resource-category">BREATHING EXERCISE</div>
                        <div class="resource-title">5-Minute Breathing Meditation</div>
                        <div class="resource-description">A quick exercise to calm your mind and body.</div>
                        <div class="resource-duration">
                            <span>üïê</span>
                            <span>5 min</span>
                        </div>
                    </div>

                    <!-- Article -->
                    <div class="resource-card" data-category="articles">
                        <div class="resource-icon">üìÑ</div>
                        <div class="resource-category">ARTICLE</div>
                        <div class="resource-title">Understanding Anxiety</div>
                        <div class="resource-description">Learn about the science behind anxiety and how to manage it.</div>
                        <div class="resource-duration">
                            <span>üìñ</span>
                            <span>8 min read</span>
                        </div>
                    </div>

                    <!-- Technique -->
                    <div class="resource-card" data-category="techniques">
                        <div class="resource-icon">üåü</div>
                        <div class="resource-category">TECHNIQUE</div>
                        <div class="resource-title">Grounding Technique: 5-4-3-2-1</div>
                        <div class="resource-description">A simple method to anchor you in the present moment.</div>
                        <div class="resource-duration">
                            <span>üïê</span>
                            <span>3 min</span>
                        </div>
                    </div>

                    <!-- Guided Meditation -->
                    <div class="resource-card" data-category="meditations">
                        <div class="resource-icon">üéß</div>
                        <div class="resource-category">GUIDED MEDITATION</div>
                        <div class="resource-title">Meditation for Deep Sleep</div>
                        <div class="resource-description">Drift off into a restful sleep with this calming audio guide.</div>
                        <div class="resource-duration">
                            <span>üïê</span>
                            <span>15 min</span>
                        </div>
                    </div>

                    <!-- Article -->
                    <div class="resource-card" data-category="articles">
                        <div class="resource-icon">üíö</div>
                        <div class="resource-category">ARTICLE</div>
                        <div class="resource-title">The Power of Self-Compassion</div>
                        <div class="resource-description">Discover how being kind to yourself can transform your well-being.</div>
                        <div class="resource-duration">
                            <span>üìñ</span>
                            <span>7 min read</span>
                        </div>
                    </div>

                    <!-- Exercise -->
                    <div class="resource-card" data-category="exercises">
                        <div class="resource-icon">üö∂</div>
                        <div class="resource-category">EXERCISE</div>
                        <div class="resource-title">Mindful Walking Exercise</div>
                        <div class="resource-description">Connect with your surroundings and calm your thoughts.</div>
                        <div class="resource-duration">
                            <span>üïê</span>
                            <span>10 min</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emotions Tab -->
            <div id="emotions" class="tab-content">
                <h2>Registro de Emo√ß√µes</h2>

                <div class="form-group">
                    <label>Que emo√ß√£o voc√™ est√° sentindo? *</label>
                    <select id="emotionType">
                        <option value="">Selecione...</option>
                        <option value="alegria">Alegria</option>
                        <option value="tristeza">Tristeza</option>
                        <option value="raiva">Raiva</option>
                        <option value="medo">Medo</option>
                        <option value="ansiedade">Ansiedade</option>
                        <option value="calma">Calma</option>
                        <option value="frustra√ß√£o">Frustra√ß√£o</option>
                        <option value="esperan√ßa">Esperan√ßa</option>
                        <option value="vergonha">Vergonha</option>
                    </select>
                    <div class="field-error" id="emotionTypeError">Selecione uma emo√ß√£o</div>
                </div>

                <div class="form-group">
                    <label>Intensidade (0-10) *</label>
                    <input type="range" id="emotionIntensity" min="0" max="10" value="5">
                    <span id="intensityValue">5</span>
                </div>

                <div class="form-group">
                    <label>O que disparou essa emo√ß√£o?</label>
                    <textarea id="emotionTrigger" rows="3" placeholder="Descreva a situa√ß√£o... (opcional)"></textarea>
                </div>

                <div class="form-group">
                    <label>Sensa√ß√µes f√≠sicas</label>
                    <textarea id="physicalSensations" rows="2" placeholder="O que voc√™ sente no corpo? (opcional)"></textarea>
                </div>

                <div class="form-group">
                    <label>Pensamentos</label>
                    <textarea id="emotionThoughts" rows="2" placeholder="O que passa pela sua mente? (opcional)"></textarea>
                </div>

                <div class="form-group">
                    <label>Impulso de a√ß√£o</label>
                    <textarea id="actionUrge" rows="2" placeholder="O que voc√™ tem vontade de fazer? (opcional)"></textarea>
                </div>

                <button class="btn btn-success" onclick="saveEmotion()">Registrar Emo√ß√£o</button>

                <h3 style="margin-top: 30px;">Hist√≥rico de Emo√ß√µes (√∫ltimas 10)</h3>
                <div id="emotionHistory"></div>
            </div>

            <!-- Routine Tab -->
            <div id="routine" class="tab-content">
                <h2>Minha Rotina Di√°ria</h2>

                <div class="dashboard-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h3>Progresso do Dia</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" style="padding: 8px 16px; background: var(--secondary);" onclick="openRoutineConfigModal()">‚öôÔ∏è Configurar Rotina</button>
                            <button class="btn btn-danger" style="padding: 8px 16px;" onclick="resetRoutine()">Resetar</button>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="routineProgress" style="width: 0%">0%</div>
                    </div>
                </div>

                <div id="routineActivities" style="margin-top: 20px;">
                    <!-- Activities will be rendered here -->
                </div>
            </div>

            <!-- Skills Tab -->
            <div id="skills" class="tab-content">
                <h2>Habilidades DBT</h2>

                <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div class="dashboard-card" style="cursor: pointer; transition: transform 0.3s;" onclick="showSkillDetails('dearman')">
                        <h3 style="margin-bottom: 10px;">üì¢ DEAR MAN</h3>
                        <p style="font-size: 14px; color: #666;">Efetividade Interpessoal</p>
                        <p style="margin-top: 10px; font-size: 13px;">T√©cnica para pedir o que voc√™ precisa de forma efetiva</p>
                    </div>

                    <div class="dashboard-card" style="cursor: pointer; transition: transform 0.3s;" onclick="showSkillDetails('tipp')">
                        <h3 style="margin-bottom: 10px;">‚ùÑÔ∏è TIPP</h3>
                        <p style="font-size: 14px; color: #666;">Habilidades de Crise</p>
                        <p style="margin-top: 10px; font-size: 13px;">Mudar a qu√≠mica corporal rapidamente</p>
                    </div>

                    <div class="dashboard-card" style="cursor: pointer; transition: transform 0.3s;" onclick="showSkillDetails('stop')">
                        <h3 style="margin-bottom: 10px;">üõë STOP</h3>
                        <p style="font-size: 14px; color: #666;">Regula√ß√£o Emocional</p>
                        <p style="margin-top: 10px; font-size: 13px;">Pausar antes de agir impulsivamente</p>
                    </div>

                    <div class="dashboard-card" style="cursor: pointer; transition: transform 0.3s;" onclick="showSkillDetails('accepts')">
                        <h3 style="margin-bottom: 10px;">‚úÖ ACCEPTS</h3>
                        <p style="font-size: 14px; color: #666;">Toler√¢ncia ao Mal-estar</p>
                        <p style="margin-top: 10px; font-size: 13px;">Distrair-se de emo√ß√µes intensas</p>
                    </div>
                </div>

                <div class="dashboard-card" style="margin-top: 30px;">
                    <h3>Minha Carta ACCEPTS Personalizada</h3>
                    <p style="margin-bottom: 15px; font-size: 14px; color: #666;">Preencha com estrat√©gias que funcionam para voc√™</p>

                    <div class="form-group">
                        <label>Activities - Atividades que me distraem</label>
                        <textarea id="acceptsActivities" rows="2" placeholder="Ex: Jogar, programar, assistir s√©rie..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Contributing - Formas de contribuir</label>
                        <textarea id="acceptsContribute" rows="2" placeholder="Ex: Ajudar algu√©m, fazer algo √∫til..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Comparisons - Compara√ß√µes √∫teis</label>
                        <textarea id="acceptsCompare" rows="2" placeholder="Ex: Lembrar de momentos piores que superei..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Emotions - Emo√ß√µes opostas</label>
                        <textarea id="acceptsEmotions" rows="2" placeholder="Ex: Assistir com√©dia quando triste..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Pushing away - Afastar pensamentos</label>
                        <textarea id="acceptsPushing" rows="2" placeholder="Ex: Visualizar guardar preocupa√ß√µes em uma caixa..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Thoughts - Outros pensamentos</label>
                        <textarea id="acceptsThoughts" rows="2" placeholder="Ex: Contar de 100 a 0, resolver quebra-cabe√ßa..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Sensations - Sensa√ß√µes f√≠sicas intensas</label>
                        <textarea id="acceptsSensations" rows="2" placeholder="Ex: √Ågua gelada no rosto, segurar gelo..."></textarea>
                    </div>

                    <button class="btn btn-success" onclick="saveAcceptsCard()">Salvar Carta ACCEPTS</button>
                </div>
            </div>

            <!-- Mindfulness Tab -->
            <div id="mindfulness" class="tab-content">
                <h2>Pr√°ticas de Mindfulness</h2>

                <div class="dashboard-card">
                    <h3>Registrar Nova Pr√°tica</h3>

                    <div class="form-group">
                        <label>Tipo de Pr√°tica *</label>
                        <select id="practiceType">
                            <option value="">Selecione...</option>
                            <option value="formal">Medita√ß√£o Formal (sentado)</option>
                            <option value="informal">Mindfulness Informal</option>
                            <option value="breathing">Exerc√≠cio de Respira√ß√£o</option>
                            <option value="body-scan">Escaneamento Corporal</option>
                            <option value="walking">Caminhada Consciente</option>
                            <option value="eating">Alimenta√ß√£o Consciente</option>
                        </select>
                        <div class="field-error" id="practiceTypeError">Selecione um tipo de pr√°tica</div>
                    </div>

                    <div class="form-group">
                        <label>Dura√ß√£o (minutos) *</label>
                        <input type="number" id="practiceDuration" min="1" max="120" placeholder="Ex: 10">
                        <div class="field-error" id="practiceDurationError">Insira a dura√ß√£o</div>
                    </div>

                    <div class="form-group">
                        <label>Como foi a experi√™ncia?</label>
                        <textarea id="practiceNotes" rows="3" placeholder="Descreva sua pr√°tica... (opcional)"></textarea>
                    </div>

                    <button class="btn btn-success" onclick="savePractice()">Registrar Pr√°tica</button>
                </div>

                <h3 style="margin-top: 30px;">Hist√≥rico de Pr√°ticas</h3>
                <div id="practiceHistory">Carregando...</div>

                <div class="dashboard-card" style="margin-top: 20px;">
                    <h3>Estat√≠sticas de Mindfulness</h3>
                    <div id="practiceStats">Carregando...</div>
                </div>
            </div>

            <!-- Sessions Tab -->
            <div id="sessions" class="tab-content">
                <h2>Anota√ß√µes de Sess√µes Terap√™uticas</h2>

                <div class="dashboard-card">
                    <h3>Registrar Nova Sess√£o</h3>

                    <div class="form-group">
                        <label>Data da Sess√£o *</label>
                        <input type="date" id="sessionDate">
                        <div class="field-error" id="sessionDateError">Selecione uma data</div>
                    </div>

                    <div class="form-group">
                        <label>Resumo da Sess√£o *</label>
                        <textarea id="sessionSummary" rows="4" placeholder="O que foi discutido na sess√£o..."></textarea>
                        <div class="field-error" id="sessionSummaryError">Adicione um resumo</div>
                    </div>

                    <div class="form-group">
                        <label>Tarefas para Casa</label>
                        <textarea id="sessionHomework" rows="3" placeholder="- Tarefa 1&#10;- Tarefa 2&#10;- Tarefa 3 (opcional)"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Insights Importantes</label>
                        <textarea id="sessionInsights" rows="3" placeholder="Percep√ß√µes e aprendizados... (opcional)"></textarea>
                    </div>

                    <button class="btn btn-success" onclick="saveSession()">Salvar Sess√£o</button>
                </div>

                <h3 style="margin-top: 30px;">Sess√µes Anteriores</h3>
                <div id="sessionHistory">Carregando...</div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="settings-container">
                    <!-- Sidebar -->
                    <div class="settings-sidebar">
                        <div class="sidebar-profile">
                            <div class="sidebar-profile-pic">üë§</div>
                            <div style="font-weight: 600; margin-bottom: 3px; color: var(--dark-text);" id="sidebarUserName">Alex Doe</div>
                            <div style="font-size: 13px; color: var(--dark-text-secondary);" id="sidebarUserEmail">alex.doe@example.com</div>
                        </div>

                        <div class="sidebar-menu">
                            <div class="sidebar-item active" onclick="switchSettingsSection('profile', this)">
                                <span>üë§</span>
                                <span>Profile</span>
                            </div>
                            <div class="sidebar-item" onclick="switchSettingsSection('preferences', this)">
                                <span>‚öôÔ∏è</span>
                                <span>Preferences</span>
                            </div>
                            <div class="sidebar-item" onclick="switchSettingsSection('notifications', this)">
                                <span>üîî</span>
                                <span>Notifications</span>
                            </div>
                            <div class="sidebar-item" onclick="switchSettingsSection('privacy', this)">
                                <span>üîí</span>
                                <span>Privacy</span>
                            </div>
                            <div class="sidebar-item" onclick="switchSettingsSection('account', this)">
                                <span>üîë</span>
                                <span>Account</span>
                            </div>
                        </div>

                        <div style="padding: 20px;">
                            <button class="btn" style="width: 100%; background: transparent; border: 2px solid var(--dark-border); color: var(--dark-text-secondary); padding: 10px;" onclick="logout()">
                                <span>üö™</span> Logout
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="settings-content">
                        <!-- Profile Section -->
                        <div id="profile-section" class="settings-section active">
                            <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--dark-border);">
                                <h2 style="margin: 0; color: var(--dark-text);">Profile</h2>
                                <p style="color: var(--dark-text-secondary); margin-top: 5px;">Update your photo and personal details.</p>
                            </div>

                            <div class="profile-section">
                                <div class="profile-header">
                                    <div class="profile-picture">üë§</div>
                                    <div style="flex: 1;">
                                        <h3 style="margin: 0 0 5px 0; color: var(--dark-text);" id="profileUserName">Alex Doe</h3>
                                        <p style="margin: 0; color: var(--dark-text-secondary); font-size: 14px;" id="profileUserEmail">alex.doe@example.com</p>
                                    </div>
                                    <div class="profile-actions">
                                        <button class="btn btn-delete">Delete</button>
                                        <button class="btn btn-upload">Upload new picture</button>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label style="color: var(--dark-text);">Full Name</label>
                                        <input type="text" id="profileFullName" value="Alex Doe" style="background: var(--dark-sidebar); color: var(--dark-text); border-color: var(--dark-border);">
                                    </div>
                                    <div class="form-group">
                                        <label style="color: var(--dark-text);">Email Address</label>
                                        <input type="email" id="profileEmail" value="alex.doe@example.com" style="background: var(--dark-sidebar); color: var(--dark-text); border-color: var(--dark-border);">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label style="color: var(--dark-text);">Join Date</label>
                                    <input type="text" value="October 26, 2023" disabled style="background: var(--dark-sidebar); color: var(--dark-text-secondary); border-color: var(--dark-border); cursor: not-allowed;">
                                </div>

                                <div class="form-actions">
                                    <button class="btn btn-cancel">Cancel</button>
                                    <button class="btn btn-save" onclick="saveProfile()">Save Changes</button>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences Section -->
                        <div id="preferences-section" class="settings-section" style="display: none;">
                            <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--dark-border);">
                                <h2 style="margin: 0; color: var(--dark-text);">Preferences</h2>
                                <p style="color: var(--dark-text-secondary); margin-top: 5px;">Customize your app experience.</p>
                            </div>

                            <div class="profile-section">
                                <h3 style="margin: 0 0 20px 0; color: var(--dark-text);">Theme</h3>
                                <div style="display: flex; gap: 15px;">
                                    <label style="flex: 1; padding: 20px; background: var(--dark-sidebar); border: 2px solid var(--dark-border); border-radius: 10px; cursor: pointer;">
                                        <input type="radio" name="theme" value="light" style="margin-right: 10px;">
                                        <span style="color: var(--dark-text);">Light Mode</span>
                                    </label>
                                    <label style="flex: 1; padding: 20px; background: var(--dark-sidebar); border: 2px solid var(--green-primary); border-radius: 10px; cursor: pointer;">
                                        <input type="radio" name="theme" value="dark" checked style="margin-right: 10px;">
                                        <span style="color: var(--dark-text);">Dark Mode</span>
                                    </label>
                                </div>
                            </div>

                            <div class="profile-section">
                                <h3 style="margin: 0 0 20px 0; color: var(--dark-text);">Language</h3>
                                <select style="width: 100%; background: var(--dark-sidebar); color: var(--dark-text); border-color: var(--dark-border);">
                                    <option>Portugu√™s (Brasil)</option>
                                    <option>English</option>
                                    <option>Espa√±ol</option>
                                </select>
                            </div>
                        </div>

                        <!-- Notifications Section -->
                        <div id="notifications-section" class="settings-section" style="display: none;">
                            <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--dark-border);">
                                <h2 style="margin: 0; color: var(--dark-text);">Notifications</h2>
                                <p style="color: var(--dark-text-secondary); margin-top: 5px;">Manage your notification preferences.</p>
                            </div>

                            <div class="profile-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--dark-border);">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: var(--dark-text);">Daily Reminders</h4>
                                        <p style="margin: 0; color: var(--dark-text-secondary); font-size: 14px;">Receive daily mood check-in reminders</p>
                                    </div>
                                    <div class="theme-toggle" onclick="toggleNotification('daily')"></div>
                                </div>

                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--dark-border);">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: var(--dark-text);">Weekly Insights</h4>
                                        <p style="margin: 0; color: var(--dark-text-secondary); font-size: 14px;">Get weekly summaries of your progress</p>
                                    </div>
                                    <div class="theme-toggle" onclick="toggleNotification('weekly')"></div>
                                </div>

                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0;">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: var(--dark-text);">Email Notifications</h4>
                                        <p style="margin: 0; color: var(--dark-text-secondary); font-size: 14px;">Receive notifications via email</p>
                                    </div>
                                    <div class="theme-toggle" onclick="toggleNotification('email')"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Privacy Section -->
                        <div id="privacy-section" class="settings-section" style="display: none;">
                            <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--dark-border);">
                                <h2 style="margin: 0; color: var(--dark-text);">Privacy</h2>
                                <p style="color: var(--dark-text-secondary); margin-top: 5px;">Control your data and privacy settings.</p>
                            </div>

                            <div class="profile-section">
                                <h3 style="margin: 0 0 15px 0; color: var(--dark-text);">Data Privacy</h3>
                                <p style="color: var(--dark-text-secondary); margin-bottom: 20px;">Your data is stored locally on your device and is never shared with third parties.</p>

                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-success" onclick="exportBackup()">üì• Download My Data</button>
                                    <button class="btn btn-delete" onclick="confirmDeleteAllData()">üóëÔ∏è Delete All Data</button>
                                </div>
                            </div>
                        </div>

                        <!-- Account Section -->
                        <div id="account-section" class="settings-section" style="display: none;">
                            <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--dark-border);">
                                <h2 style="margin: 0; color: var(--dark-text);">Account</h2>
                                <p style="color: var(--dark-text-secondary); margin-top: 5px;">Manage your account settings.</p>
                            </div>

                            <div class="profile-section">
                                <h3 style="margin: 0 0 20px 0; color: var(--dark-text);">Data Management</h3>
                                <p><strong style="color: var(--dark-text);">Sistema de persist√™ncia:</strong> <span style="color: var(--dark-text-secondary);">localStorage + IndexedDB</span></p>
                                <p id="storageInfo" style="color: var(--dark-text-secondary);">Carregando informa√ß√µes...</p>

                                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                                    <button class="btn btn-success" onclick="exportBackup()">üì• Baixar Backup JSON</button>
                                    <button class="btn btn-secondary" onclick="document.getElementById('restoreInput').click()">üì§ Restaurar Backup</button>
                                    <button class="btn" style="background: #ff6b6b;" onclick="exportPDF()">üìÑ Gerar Relat√≥rio PDF</button>
                                    <input type="file" id="restoreInput" accept=".json" style="display: none;" onchange="restoreBackup(event)">
                                </div>
                            </div>

                            <div class="profile-section">
                                <h3 style="margin: 0 0 15px 0; color: var(--dark-text);">Estat√≠sticas</h3>
                                <div id="stats" style="color: var(--dark-text-secondary);">Carregando...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Mood Modal -->
    <div id="quickMoodModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registro R√°pido</h2>
                <span class="close-modal" onclick="closeQuickModal()">&times;</span>
            </div>
            <p>Humor salvo com sucesso! üéâ</p>
        </div>
    </div>

    <!-- Skill Details Modal -->
    <div id="skillModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="skillModalTitle">Habilidade DBT</h2>
                <span class="close-modal" onclick="closeSkillModal()">&times;</span>
            </div>
            <div id="skillModalContent">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Routine Configuration Modal -->
    <div id="routineConfigModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configurar Minha Rotina</h2>
                <span class="close-modal" onclick="closeRoutineConfigModal()">&times;</span>
            </div>
            <p style="margin-bottom: 20px; color: #666;">Personalize suas atividades di√°rias. Voc√™ pode adicionar, remover e reordenar as atividades.</p>

            <div id="activityConfigList" style="max-height: 400px; overflow-y: auto;">
                <!-- Activities will be rendered here -->
            </div>

            <button class="btn" style="width: 100%; margin-top: 15px; background: var(--accent);" onclick="addNewActivity()">
                ‚ûï Adicionar Atividade
            </button>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" style="flex: 1;" onclick="saveRoutineConfig()">Salvar Configura√ß√£o</button>
                <button class="btn" style="flex: 1; background: #999;" onclick="resetToDefaultRoutine()">Restaurar Padr√£o</button>
            </div>
        </div>
    </div>

    <!-- ============================================================================
         ONBOARDING MODAL
         ============================================================================ -->

    <div class="onboarding-overlay" id="onboardingModal">
        <div class="onboarding-container">
            <!-- Progress Bar -->
            <div class="onboarding-progress">
                <div class="progress-step active" id="progress1"></div>
                <div class="progress-step" id="progress2"></div>
                <div class="progress-step" id="progress3"></div>
            </div>

            <!-- Step 1: Primeiro Registro de Humor -->
            <div class="onboarding-step active" id="step1">
                <h2 class="onboarding-title">Bem-vindo(a)! üå±</h2>
                <p class="onboarding-description">
                    Vamos come√ßar sua jornada de auto-conhecimento.<br>
                    Como voc√™ est√° se sentindo agora?
                </p>
                <div class="onboarding-content">
                    <div class="mood-scale">
                        <span class="mood-emoji" onclick="selectOnboardingMood(1)" title="Muito mal">üòî</span>
                        <span class="mood-emoji" onclick="selectOnboardingMood(2)" title="Mal">üòï</span>
                        <span class="mood-emoji" onclick="selectOnboardingMood(3)" title="Neutro">üòê</span>
                        <span class="mood-emoji" onclick="selectOnboardingMood(4)" title="Bem">üôÇ</span>
                        <span class="mood-emoji" onclick="selectOnboardingMood(5)" title="Muito bem">üòä</span>
                    </div>
                    <div style="margin-top: 20px; text-align: center; color: #999;" id="moodFeedback">
                        Selecione um emoji acima
                    </div>
                </div>
            </div>

            <!-- Step 2: Preview de Habilidades DBT -->
            <div class="onboarding-step" id="step2">
                <h2 class="onboarding-title">Conhe√ßa as Habilidades DBT üõ†Ô∏è</h2>
                <p class="onboarding-description">
                    Voc√™ ter√° acesso a t√©cnicas poderosas de regula√ß√£o emocional<br>
                    baseadas em Terapia Comportamental Dial√©tica.
                </p>
                <div class="onboarding-content">
                    <div style="background: linear-gradient(135deg, #f5f7fa, #c3cfe2); padding: 30px; border-radius: 15px; max-width: 400px; text-align: left;">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">üíÜ T√©cnica TIPP</h3>
                        <p style="line-height: 1.6; color: #555;">
                            <strong>T</strong>emperatura - Mude a temperatura do rosto<br>
                            <strong>I</strong>ntense exercise - Exerc√≠cio intenso<br>
                            <strong>P</strong>aced breathing - Respira√ß√£o compassada<br>
                            <strong>P</strong>aired muscle relaxation - Relaxamento muscular
                        </p>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.8); border-radius: 8px; font-size: 14px;">
                            ‚ú® Ideal para momentos de crise emocional intensa
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Configura√ß√£o de Lembrete -->
            <div class="onboarding-step" id="step3">
                <h2 class="onboarding-title">Mantenha-se Consistente ‚è∞</h2>
                <p class="onboarding-description">
                    Receba um lembrete di√°rio para registrar seu humor<br>
                    e manter sua pr√°tica em dia.
                </p>
                <div class="onboarding-content">
                    <div style="width: 100%; max-width: 400px;">
                        <div class="form-group">
                            <label>üìß Email (opcional)</label>
                            <input type="email" id="onboardingEmail" placeholder="seu@email.com">
                        </div>
                        <div class="form-group">
                            <label>üïê Hor√°rio do lembrete</label>
                            <select id="onboardingReminderTime">
                                <option value="">N√£o quero lembretes</option>
                                <option value="08:00">08:00 - Manh√£</option>
                                <option value="12:00">12:00 - Meio-dia</option>
                                <option value="18:00">18:00 - Tarde</option>
                                <option value="20:00" selected>20:00 - Noite</option>
                            </select>
                        </div>
                        <div style="text-align: center; margin-top: 20px; font-size: 14px; color: #888;">
                            üí° Voc√™ pode alterar isso depois nas Configura√ß√µes
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="onboarding-controls">
                <button class="btn btn-skip" onclick="skipOnboarding()">Pular Tutorial</button>
                <button class="btn" id="btnPrev" onclick="prevStep()" style="display: none;">‚Üê Anterior</button>
                <button class="btn" id="btnNext" onclick="nextStep()" disabled>Pr√≥ximo ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- ============================================================================
         BACKUP REMINDER MODAL (TASK-015)
         ============================================================================ -->

    <div class="modal" id="backupReminderModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 style="color: var(--danger);">‚ö†Ô∏è Fa√ßa Backup dos Seus Dados</h2>
                <span class="close-modal" onclick="closeBackupReminderModal()">&times;</span>
            </div>
            <div style="margin: 20px 0;">
                <p style="line-height: 1.8; margin-bottom: 15px;">
                    Voc√™ n√£o faz backup h√° <strong id="daysSinceBackup">7+</strong> dias.
                </p>
                <div style="background: rgba(246, 114, 128, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid var(--danger); margin-bottom: 20px;">
                    <p style="font-size: 14px; margin-bottom: 8px;">
                        <strong>Por que fazer backup?</strong>
                    </p>
                    <ul style="font-size: 14px; line-height: 1.6; margin-left: 20px;">
                        <li>Seus dados ficam apenas no navegador (localStorage)</li>
                        <li>Se limpar o cache, perder√° tudo</li>
                        <li>Se usar outro dispositivo, n√£o ver√° os dados</li>
                    </ul>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" style="flex: 2;" onclick="exportBackupFromModal()">
                    üì• Exportar Backup (JSON)
                </button>
                <button class="btn" style="flex: 1; background: #999;" onclick="remindBackupLater()">
                    Lembrar Depois
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // DATA SCHEMA & VALIDATION
        // ============================================================================

        const Schema = {
            // Mood entry schema
            Mood: {
                validate(data) {
                    if (!data.value || data.value < 1 || data.value > 5) {
                        return { valid: false, error: 'Valor de humor inv√°lido (1-5)' };
                    }
                    return { valid: true };
                },
                create(value, note = '') {
                    return {
                        id: generateId(),
                        value: parseInt(value),
                        note: note.trim(),
                        timestamp: new Date().toISOString(),
                        date: new Date().toISOString().split('T')[0]
                    };
                }
            },

            // Emotion entry schema
            Emotion: {
                validate(data) {
                    if (!data.type || data.type.trim() === '') {
                        return { valid: false, error: 'Tipo de emo√ß√£o √© obrigat√≥rio' };
                    }
                    if (data.intensity === undefined || data.intensity < 0 || data.intensity > 10) {
                        return { valid: false, error: 'Intensidade inv√°lida (0-10)' };
                    }
                    return { valid: true };
                },
                create(type, intensity, details = {}) {
                    return {
                        id: generateId(),
                        type: type.trim(),
                        intensity: parseInt(intensity),
                        trigger: (details.trigger || '').trim(),
                        physical: (details.physical || '').trim(),
                        thoughts: (details.thoughts || '').trim(),
                        urge: (details.urge || '').trim(),
                        timestamp: new Date().toISOString(),
                        date: new Date().toISOString().split('T')[0]
                    };
                }
            },

            // Mindfulness practice schema
            Practice: {
                validate(data) {
                    if (!data.type || data.type.trim() === '') {
                        return { valid: false, error: 'Tipo de pr√°tica √© obrigat√≥rio' };
                    }
                    if (!data.duration || data.duration < 1) {
                        return { valid: false, error: 'Dura√ß√£o deve ser maior que 0' };
                    }
                    return { valid: true };
                },
                create(type, duration, notes = '') {
                    return {
                        id: generateId(),
                        type: type.trim(),
                        duration: parseInt(duration),
                        notes: notes.trim(),
                        timestamp: new Date().toISOString(),
                        date: new Date().toISOString().split('T')[0]
                    };
                }
            },

            // Session notes schema
            Session: {
                validate(data) {
                    if (!data.date || data.date.trim() === '') {
                        return { valid: false, error: 'Data da sess√£o √© obrigat√≥ria' };
                    }
                    if (!data.summary || data.summary.trim() === '') {
                        return { valid: false, error: 'Resumo da sess√£o √© obrigat√≥rio' };
                    }
                    return { valid: true };
                },
                create(date, summary, homework = '', insights = '') {
                    return {
                        id: generateId(),
                        date: date,
                        summary: summary.trim(),
                        homework: homework.trim(),
                        insights: insights.trim(),
                        timestamp: new Date().toISOString()
                    };
                }
            }
        };

        // ============================================================================
        // DUAL PERSISTENCE LAYER (localStorage + IndexedDB)
        // ============================================================================

        class DataStore {
            constructor() {
                this.db = null;
                this.dbName = 'TherapyAppDB';
                this.dbVersion = 1;
                this.ready = false;
            }

            async init() {
                try {
                    // Initialize IndexedDB
                    this.db = await this.openDatabase();
                    this.ready = true;
                    console.log('‚úÖ IndexedDB initialized');

                    // Migrate old localStorage data if needed
                    await this.migrateOldData();

                    return true;
                } catch (error) {
                    console.error('‚ùå IndexedDB initialization failed:', error);
                    console.log('‚ö†Ô∏è Falling back to localStorage only');
                    this.ready = false;
                    return false;
                }
            }

            openDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // Create object stores
                        if (!db.objectStoreNames.contains('moods')) {
                            const moodStore = db.createObjectStore('moods', { keyPath: 'id' });
                            moodStore.createIndex('date', 'date', { unique: false });
                            moodStore.createIndex('timestamp', 'timestamp', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('emotions')) {
                            const emotionStore = db.createObjectStore('emotions', { keyPath: 'id' });
                            emotionStore.createIndex('date', 'date', { unique: false });
                            emotionStore.createIndex('type', 'type', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('practices')) {
                            const practiceStore = db.createObjectStore('practices', { keyPath: 'id' });
                            practiceStore.createIndex('date', 'date', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('sessions')) {
                            const sessionStore = db.createObjectStore('sessions', { keyPath: 'id' });
                            sessionStore.createIndex('date', 'date', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('metadata')) {
                            db.createObjectStore('metadata', { keyPath: 'key' });
                        }
                    };
                });
            }

            async save(storeName, data) {
                // Save to localStorage (primary)
                try {
                    const key = `therapy_${storeName}`;
                    let items = JSON.parse(localStorage.getItem(key) || '[]');
                    items.push(data);
                    localStorage.setItem(key, JSON.stringify(items));
                } catch (error) {
                    console.error('localStorage save error:', error);
                    throw new Error('Falha ao salvar em localStorage');
                }

                // Save to IndexedDB (backup)
                if (this.ready && this.db) {
                    try {
                        await this.saveToIndexedDB(storeName, data);
                    } catch (error) {
                        console.warn('IndexedDB save warning:', error);
                        // Don't throw - localStorage is primary
                    }
                }

                return data;
            }

            saveToIndexedDB(storeName, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAll(storeName) {
                // Try localStorage first
                try {
                    const key = `therapy_${storeName}`;
                    const data = JSON.parse(localStorage.getItem(key) || '[]');
                    return data;
                } catch (error) {
                    console.error('localStorage read error:', error);

                    // Fallback to IndexedDB
                    if (this.ready && this.db) {
                        return await this.getAllFromIndexedDB(storeName);
                    }

                    return [];
                }
            }

            getAllFromIndexedDB(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            }

            async setMetadata(key, value) {
                localStorage.setItem(`therapy_meta_${key}`, JSON.stringify(value));

                if (this.ready && this.db) {
                    try {
                        const transaction = this.db.transaction(['metadata'], 'readwrite');
                        const store = transaction.objectStore('metadata');
                        store.put({ key, value, timestamp: new Date().toISOString() });
                    } catch (error) {
                        console.warn('Metadata save warning:', error);
                    }
                }
            }

            async getMetadata(key) {
                try {
                    const value = localStorage.getItem(`therapy_meta_${key}`);
                    return value ? JSON.parse(value) : null;
                } catch (error) {
                    return null;
                }
            }

            async migrateOldData() {
                // Migrate from old format to new normalized schema
                const oldMoods = localStorage.getItem('moods');
                const oldEmotions = localStorage.getItem('emotions');

                if (oldMoods && !localStorage.getItem('therapy_moods')) {
                    console.log('üì¶ Migrating old mood data...');
                    try {
                        const moods = JSON.parse(oldMoods);
                        const normalized = moods.map(m => Schema.Mood.create(m.value, ''));
                        localStorage.setItem('therapy_moods', JSON.stringify(normalized));
                    } catch (error) {
                        console.error('Migration error:', error);
                    }
                }

                if (oldEmotions && !localStorage.getItem('therapy_emotions')) {
                    console.log('üì¶ Migrating old emotion data...');
                    try {
                        const emotions = JSON.parse(oldEmotions);
                        const normalized = emotions.map(e =>
                            Schema.Emotion.create(e.type, e.intensity, {
                                trigger: e.trigger,
                                physical: e.physical,
                                thoughts: e.thoughts,
                                urge: e.urge
                            })
                        );
                        localStorage.setItem('therapy_emotions', JSON.stringify(normalized));
                    } catch (error) {
                        console.error('Migration error:', error);
                    }
                }
            }

            async exportAll() {
                const data = {
                    version: 2,
                    exportDate: new Date().toISOString(),
                    moods: await this.getAll('moods'),
                    emotions: await this.getAll('emotions'),
                    practices: await this.getAll('practices'),
                    sessions: await this.getAll('sessions'),
                    metadata: {
                        lastBackup: await this.getMetadata('lastBackup'),
                        darkMode: await this.getMetadata('darkMode')
                    }
                };
                return data;
            }

            async importAll(data) {
                if (!data.version || data.version < 2) {
                    throw new Error('Formato de backup incompat√≠vel');
                }

                // Clear existing data
                localStorage.removeItem('therapy_moods');
                localStorage.removeItem('therapy_emotions');
                localStorage.removeItem('therapy_practices');
                localStorage.removeItem('therapy_sessions');

                // Import new data
                if (data.moods) localStorage.setItem('therapy_moods', JSON.stringify(data.moods));
                if (data.emotions) localStorage.setItem('therapy_emotions', JSON.stringify(data.emotions));
                if (data.practices) localStorage.setItem('therapy_practices', JSON.stringify(data.practices));
                if (data.sessions) localStorage.setItem('therapy_sessions', JSON.stringify(data.sessions));

                // Import metadata
                if (data.metadata) {
                    for (const [key, value] of Object.entries(data.metadata)) {
                        if (value !== null) await this.setMetadata(key, value);
                    }
                }

                // Sync to IndexedDB
                if (this.ready && this.db) {
                    // Clear IndexedDB stores
                    const stores = ['moods', 'emotions', 'practices', 'sessions'];
                    for (const store of stores) {
                        await this.clearStore(store);
                        const items = data[store] || [];
                        for (const item of items) {
                            await this.saveToIndexedDB(store, item);
                        }
                    }
                }

                return true;
            }

            clearStore(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // ============================================================================
        // APPLICATION STATE
        // ============================================================================

        const App = {
            store: new DataStore(),
            currentMood: null,

            async init() {
                console.log('üöÄ Initializing Therapy App v2...');

                // Initialize data store
                await this.store.init();

                // Load theme
                const darkMode = await this.store.getMetadata('darkMode');
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                }

                // Update UI
                updateDate();
                await this.updateDashboard();
                await this.loadEmotionHistory();
                await this.updateBackupBadge();
                await this.updateStats();

                // Render charts and visualizations
                await this.renderMoodChart(this.currentPeriod);

                // Load practice and session data
                await this.loadPracticeHistory();
                await this.updatePracticeStats();
                await this.loadSessionHistory();

                // Load routine and ACCEPTS card
                await renderRoutine();
                await loadAcceptsCard();

                document.getElementById('dataStatus').textContent =
                    this.store.ready ? '‚úÖ Persist√™ncia ativa' : '‚ö†Ô∏è Apenas localStorage';

                console.log('‚úÖ App initialized');
            },

            async updateDashboard() {
                const moods = await this.store.getAll('moods');
                const emotions = await this.store.getAll('emotions');

                // Get data for last 7 days
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                const weekMoods = moods.filter(m => new Date(m.date) >= sevenDaysAgo);
                const weekEmotions = emotions.filter(e => new Date(e.date) >= sevenDaysAgo);

                // Update Week Mood Average Card
                const weekMoodAvgEl = document.getElementById('weekMoodAvg');
                const weekMoodChangeEl = document.getElementById('weekMoodChange');

                if (weekMoods.length >= 3) {
                    const avgMood = (weekMoods.reduce((sum, m) => sum + m.value, 0) / weekMoods.length).toFixed(1);
                    const emojis = ['', 'üòî', 'üòï', 'üòê', 'üôÇ', 'üòä'];
                    const rounded = Math.round(parseFloat(avgMood));

                    weekMoodAvgEl.textContent = `${emojis[rounded]} ${avgMood}/5`;

                    // Calculate change vs previous week
                    const fourteenDaysAgo = new Date(today);
                    fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 14);
                    const prevWeekMoods = moods.filter(m => {
                        const date = new Date(m.date);
                        return date >= fourteenDaysAgo && date < sevenDaysAgo;
                    });

                    if (prevWeekMoods.length >= 3) {
                        const prevAvg = prevWeekMoods.reduce((sum, m) => sum + m.value, 0) / prevWeekMoods.length;
                        const change = ((avgMood - prevAvg) / prevAvg * 100).toFixed(0);
                        const arrow = change > 0 ? '‚Üë' : change < 0 ? '‚Üì' : '‚Üí';
                        const color = change > 0 ? '#82ca9d' : change < 0 ? '#f67280' : '#666';

                        weekMoodChangeEl.innerHTML = `<span style="color: ${color};">${arrow} ${Math.abs(change)}% vs semana anterior</span>`;
                    } else {
                        weekMoodChangeEl.textContent = `${weekMoods.length} registros esta semana`;
                    }
                } else {
                    weekMoodAvgEl.textContent = '-';
                    weekMoodChangeEl.textContent = 'Registre pelo menos 3 humores';
                }

                // Show/hide visualizations based on data availability (C3 + TASK-009)
                const moodChartCard = document.getElementById('moodChartCard');
                const emptyStatePlaceholder = document.getElementById('emptyStatePlaceholder');
                const progressState = document.getElementById('progressState');

                // TASK-009: Enhanced empty states
                if (moods.length === 0) {
                    // Truly empty - never registered
                    moodChartCard.style.display = 'none';
                    emptyStatePlaceholder.style.display = 'block';
                    progressState.style.display = 'none';
                } else if (moods.length < 7) {
                    // Has some data but not enough for full insights
                    moodChartCard.style.display = 'none';
                    emptyStatePlaceholder.style.display = 'none';
                    progressState.style.display = 'block';

                    // Update progress state UI
                    document.getElementById('recordCount').textContent = moods.length;
                    const percentage = Math.round((moods.length / 7) * 100);
                    document.getElementById('progressPercentage').textContent = `${percentage}%`;
                    document.getElementById('progressBar').style.width = `${percentage}%`;
                } else {
                    // Enough data - show full visualizations
                    if (weekMoods.length >= 3) {
                        moodChartCard.style.display = 'block';
                    } else {
                        moodChartCard.style.display = 'none';
                    }
                    emptyStatePlaceholder.style.display = 'none';
                    progressState.style.display = 'none';
                }

                // Top 3 Emotions (A1)
                const top3EmotionsCard = document.getElementById('top3EmotionsCard');
                if (weekEmotions.length >= 3) {
                    top3EmotionsCard.style.display = 'block';
                    await this.renderTop3Emotions();
                } else {
                    top3EmotionsCard.style.display = 'none';
                }

                // Weekly Insight (A2)
                await this.renderWeeklyInsight();
            },

            async loadEmotionHistory() {
                const emotions = await this.store.getAll('emotions');
                const historyDiv = document.getElementById('emotionHistory');

                if (emotions.length === 0) {
                    historyDiv.innerHTML = '<p>Nenhuma emo√ß√£o registrada ainda.</p>';
                    return;
                }

                const recent = emotions.slice(-10).reverse();
                historyDiv.innerHTML = recent.map(e => `
                    <div class="emotion-log">
                        <div class="note-date">${formatDateTime(e.timestamp)}</div>
                        <strong>${e.type} (Intensidade: ${e.intensity}/10)</strong>
                        ${e.trigger ? `<p><strong>Gatilho:</strong> ${e.trigger}</p>` : ''}
                        ${e.thoughts ? `<p><strong>Pensamentos:</strong> ${e.thoughts}</p>` : ''}
                    </div>
                `).join('');
            },

            async renderTop3Emotions() {
                const emotions = await this.store.getAll('emotions');

                // Get emotions from last 7 days
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                const weekEmotions = emotions.filter(e => new Date(e.date) >= sevenDaysAgo);

                if (weekEmotions.length < 3) {
                    return; // Card will be hidden by updateDashboard()
                }

                // Count emotions
                const emotionCounts = {};
                weekEmotions.forEach(e => {
                    const type = e.type.charAt(0).toUpperCase() + e.type.slice(1);
                    emotionCounts[type] = (emotionCounts[type] || 0) + 1;
                });

                // Get top 3
                const sorted = Object.entries(emotionCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);

                // Emotion emojis
                const emotionEmojis = {
                    'Alegria': 'üòä',
                    'Tristeza': 'üò¢',
                    'Raiva': 'üò†',
                    'Medo': 'üò∞',
                    'Ansiedade': 'üò∞',
                    'Calma': 'üòå',
                    'Frustra√ß√£o': 'üò§',
                    'Esperan√ßa': 'üåü',
                    'Vergonha': 'üò≥'
                };

                const container = document.getElementById('top3Emotions');
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        ${sorted.map(([emotion, count]) => `
                            <div style="text-align: center; padding: 20px; background: rgba(107, 91, 149, 0.1); border-radius: 10px;">
                                <div style="font-size: 36px; margin-bottom: 10px;">${emotionEmojis[emotion] || 'üòä'}</div>
                                <div style="font-weight: bold; margin-bottom: 5px;">${emotion}</div>
                                <div style="color: #666; font-size: 14px;">${count}x esta semana</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            async generateWeeklyInsight() {
                const moods = await this.store.getAll('moods');
                const practices = await this.store.getAll('practices');

                // Get data for last 2 weeks
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const fourteenDaysAgo = new Date(today);
                fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 14);

                const thisWeekMoods = moods.filter(m => new Date(m.date) >= sevenDaysAgo);
                const lastWeekMoods = moods.filter(m => {
                    const date = new Date(m.date);
                    return date >= fourteenDaysAgo && date < sevenDaysAgo;
                });
                const thisWeekPractices = practices.filter(p => new Date(p.date) >= sevenDaysAgo);

                // Insight #1: Mood trend
                if (thisWeekMoods.length >= 3 && lastWeekMoods.length >= 3) {
                    const thisAvg = thisWeekMoods.reduce((sum, m) => sum + m.value, 0) / thisWeekMoods.length;
                    const lastAvg = lastWeekMoods.reduce((sum, m) => sum + m.value, 0) / lastWeekMoods.length;
                    const delta = ((thisAvg - lastAvg) / lastAvg * 100).toFixed(0);

                    if (delta > 10) {
                        return {
                            emoji: 'üéâ',
                            text: `Seu humor melhorou ${delta}% esta semana! Continue assim.`,
                            type: 'positive'
                        };
                    } else if (delta < -10) {
                        return {
                            emoji: 'üíô',
                            text: `Seu humor caiu ${Math.abs(delta)}% esta semana. Considere usar habilidades DBT (TIPP, ACCEPTS).`,
                            type: 'support'
                        };
                    }
                }

                // Insight #2: Practice consistency
                if (thisWeekPractices.length >= 4) {
                    return {
                        emoji: 'üßò',
                        text: `Voc√™ praticou mindfulness ${thisWeekPractices.length}x esta semana. Excelente consist√™ncia!`,
                        type: 'positive'
                    };
                }

                // Insight #3: Low mood streak
                const last3Days = moods.slice(-3);
                if (last3Days.length === 3 && last3Days.every(m => m.value <= 2)) {
                    return {
                        emoji: 'üíô',
                        text: `3 dias seguidos com humor baixo. Lembre-se de usar suas habilidades DBT. Voc√™ n√£o est√° sozinho.`,
                        type: 'support'
                    };
                }

                // Insight #4: Good mood streak
                const last5Days = moods.slice(-5);
                if (last5Days.length === 5 && last5Days.every(m => m.value >= 4)) {
                    return {
                        emoji: 'üåü',
                        text: `5 dias seguidos com humor positivo! Voc√™ est√° indo muito bem.`,
                        type: 'positive'
                    };
                }

                // Fallback
                return {
                    emoji: 'üå±',
                    text: 'Continue registrando seu humor diariamente para receber insights personalizados.',
                    type: 'neutral'
                };
            },

            async renderWeeklyInsight() {
                const insight = await this.generateWeeklyInsight();
                const insightCard = document.getElementById('insightCard');
                const insightText = document.getElementById('insightText');

                const colors = {
                    positive: '#82ca9d',
                    support: '#88b0d3',
                    neutral: '#ffb447'
                };

                insightCard.style.borderLeftColor = colors[insight.type];
                insightText.textContent = `${insight.emoji} ${insight.text}`;

                // Analytics tracking - insight visualizado
                trackEvent('visualizacao_insight', {
                    tipo_insight: insight.type,
                    emoji: insight.emoji,
                    timestamp: new Date().toISOString()
                });
            },

            async updateBackupBadge() {
                const lastBackup = await this.store.getMetadata('lastBackup');
                const badge = document.getElementById('backupBadge');
                const text = document.getElementById('backupText');

                if (!lastBackup) {
                    text.textContent = 'Backup: nunca';
                    badge.classList.add('warning');
                } else {
                    const days = Math.floor((Date.now() - new Date(lastBackup)) / (1000 * 60 * 60 * 24));
                    text.textContent = `Backup: ${days === 0 ? 'hoje' : days + 'd atr√°s'}`;
                    badge.classList.toggle('warning', days > 7);
                }
            },

            async updateStats() {
                const moods = await this.store.getAll('moods');
                const emotions = await this.store.getAll('emotions');
                const practices = await this.store.getAll('practices');
                const sessions = await this.store.getAll('sessions');

                const statsDiv = document.getElementById('stats');
                statsDiv.innerHTML = `
                    <p><strong>Total de registros:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Humor: ${moods.length}</li>
                        <li>Emo√ß√µes: ${emotions.length}</li>
                        <li>Pr√°ticas: ${practices.length}</li>
                        <li>Sess√µes: ${sessions.length}</li>
                    </ul>
                `;

                const storageInfo = document.getElementById('storageInfo');
                storageInfo.innerHTML = `
                    <p style="margin-top: 10px;">
                        <strong>Status:</strong> ${App.store.ready ?
                            '‚úÖ localStorage + IndexedDB ativo' :
                            '‚ö†Ô∏è Apenas localStorage (IndexedDB indispon√≠vel)'}
                    </p>
                `;
            },

            moodChart: null,
            currentPeriod: 7,

            async renderMoodChart(days = 7) {
                const moods = await this.store.getAll('moods');

                // Get data for the last N days (only days with data)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - days);

                // Collect only days with mood data
                const labels = [];
                const dataPoints = [];

                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayMoods = moods.filter(m => m.date === dateStr);

                    if (dayMoods.length > 0) {
                        const avg = dayMoods.reduce((sum, m) => sum + m.value, 0) / dayMoods.length;

                        // Format label based on period
                        const date = new Date(dateStr + 'T00:00:00');
                        let label;
                        if (days === 7) {
                            // Show day of week for 7-day view
                            const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
                            label = weekDays[date.getDay()];
                        } else {
                            // Show date for 30-day view
                            label = `${date.getDate()}/${date.getMonth() + 1}`;
                        }

                        labels.push(label);
                        dataPoints.push(parseFloat(avg.toFixed(1)));
                    }
                }

                const ctx = document.getElementById('moodChart');
                if (!ctx) return;

                // Destroy existing chart
                if (this.moodChart) {
                    this.moodChart.destroy();
                }

                this.moodChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Humor M√©dio',
                            data: dataPoints,
                            borderColor: '#6b5b95',
                            backgroundColor: 'rgba(107, 91, 149, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#6b5b95',
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const emojis = ['', 'üòî', 'üòï', 'üòê', 'üôÇ', 'üòä'];
                                        const value = context.parsed.y;
                                        const rounded = Math.round(value);
                                        return `Humor: ${value}/5 ${emojis[rounded] || ''}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 0,
                                max: 5,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        const emojis = ['', 'üòî', 'üòï', 'üòê', 'üôÇ', 'üòä'];
                                        return emojis[value] || value;
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 0,
                                    minRotation: 0,
                                    autoSkip: false
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            },

            async updateWeeklyComparison() {
                const moods = await this.store.getAll('moods');
                const emotions = await this.store.getAll('emotions');

                const today = new Date();

                // Current week (last 7 days)
                const weekStart = new Date(today);
                weekStart.setDate(weekStart.getDate() - 7);

                // Previous week (8-14 days ago)
                const prevWeekStart = new Date(today);
                prevWeekStart.setDate(prevWeekStart.getDate() - 14);
                const prevWeekEnd = new Date(today);
                prevWeekEnd.setDate(prevWeekEnd.getDate() - 8);

                // Calculate current week stats
                const currentWeekMoods = moods.filter(m => {
                    const moodDate = new Date(m.date);
                    return moodDate >= weekStart && moodDate <= today;
                });

                const currentWeekEmotions = emotions.filter(e => {
                    const emotionDate = new Date(e.date);
                    return emotionDate >= weekStart && emotionDate <= today;
                });

                // Calculate previous week stats
                const prevWeekMoods = moods.filter(m => {
                    const moodDate = new Date(m.date);
                    return moodDate >= prevWeekStart && moodDate <= prevWeekEnd;
                });

                const prevWeekEmotions = emotions.filter(e => {
                    const emotionDate = new Date(e.date);
                    return emotionDate >= prevWeekStart && emotionDate <= prevWeekEnd;
                });

                // Calculate averages
                const currentAvg = currentWeekMoods.length > 0
                    ? (currentWeekMoods.reduce((sum, m) => sum + m.value, 0) / currentWeekMoods.length).toFixed(1)
                    : 'N/A';

                const prevAvg = prevWeekMoods.length > 0
                    ? (prevWeekMoods.reduce((sum, m) => sum + m.value, 0) / prevWeekMoods.length).toFixed(1)
                    : 'N/A';

                const moodDelta = currentAvg !== 'N/A' && prevAvg !== 'N/A'
                    ? (currentAvg - prevAvg).toFixed(1)
                    : 'N/A';

                const moodDeltaSymbol = moodDelta > 0 ? 'üìà' : moodDelta < 0 ? 'üìâ' : '‚û°Ô∏è';

                const comparisonDiv = document.getElementById('comparisonStats');
                comparisonDiv.innerHTML = `
                    <p><strong>Humor m√©dio:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li>Semana atual: ${currentAvg} ${moodDeltaSymbol}</li>
                        <li>Semana anterior: ${prevAvg}</li>
                        ${moodDelta !== 'N/A' ? `<li>Diferen√ßa: ${moodDelta > 0 ? '+' : ''}${moodDelta}</li>` : ''}
                    </ul>
                    <p style="margin-top: 10px;"><strong>Registros:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li>Emo√ß√µes esta semana: ${currentWeekEmotions.length}</li>
                        <li>Emo√ß√µes semana anterior: ${prevWeekEmotions.length}</li>
                    </ul>
                `;
            },

            async renderEmotionHeatmap() {
                const emotions = await this.store.getAll('emotions');

                // Get last 7 days
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                // Count emotions by type for each day
                const emotionTypes = ['alegria', 'tristeza', 'raiva', 'medo', 'ansiedade', 'calma', 'frustra√ß√£o', 'esperan√ßa', 'vergonha'];
                const heatmapData = {};

                for (let d = new Date(sevenDaysAgo); d <= today; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    heatmapData[dateStr] = {};

                    emotionTypes.forEach(type => {
                        const count = emotions.filter(e => e.date === dateStr && e.type === type).length;
                        heatmapData[dateStr][type] = count;
                    });
                }

                // Render as simple grid
                const heatmapDiv = document.getElementById('emotionHeatmap');
                let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';

                // Header row (days)
                html += '<tr><th style="padding: 8px; border: 1px solid #ddd;">Emo√ß√£o</th>';
                Object.keys(heatmapData).forEach(dateStr => {
                    const date = new Date(dateStr);
                    html += `<th style="padding: 8px; border: 1px solid #ddd; font-size: 12px;">${date.getDate()}/${date.getMonth() + 1}</th>`;
                });
                html += '</tr>';

                // Data rows (emotions)
                emotionTypes.forEach(type => {
                    html += `<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: 500;">${type}</td>`;
                    Object.values(heatmapData).forEach(dayData => {
                        const count = dayData[type];
                        const intensity = count > 0 ? Math.min(count * 30, 100) : 0;
                        const bgColor = count > 0 ? `rgba(107, 91, 149, ${intensity/100})` : '#f5f5f5';
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: ${bgColor};">${count || ''}</td>`;
                    });
                    html += '</tr>';
                });

                html += '</table></div>';
                html += '<p style="margin-top: 10px; font-size: 12px; color: #666;">Cor mais escura = maior frequ√™ncia</p>';

                heatmapDiv.innerHTML = html;
            },

            async loadPracticeHistory() {
                const practices = await this.store.getAll('practices');
                const historyDiv = document.getElementById('practiceHistory');

                if (practices.length === 0) {
                    historyDiv.innerHTML = '<p>Nenhuma pr√°tica registrada ainda.</p>';
                    return;
                }

                const recent = practices.slice(-10).reverse();
                historyDiv.innerHTML = recent.map(p => `
                    <div class="emotion-log" style="border-left-color: #82ca9d;">
                        <div class="note-date">${formatDateTime(p.timestamp)}</div>
                        <strong>${p.type} - ${p.duration} minutos</strong>
                        ${p.notes ? `<p>${p.notes}</p>` : ''}
                    </div>
                `).join('');
            },

            async updatePracticeStats() {
                const practices = await this.store.getAll('practices');
                const statsDiv = document.getElementById('practiceStats');

                if (practices.length === 0) {
                    statsDiv.innerHTML = '<p>Sem pr√°ticas registradas.</p>';
                    return;
                }

                // Calculate stats
                const totalMinutes = practices.reduce((sum, p) => sum + parseInt(p.duration), 0);
                const avgDuration = (totalMinutes / practices.length).toFixed(1);

                // This month
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const thisMonthPractices = practices.filter(p => new Date(p.date) >= firstDayOfMonth);

                const typeCount = {};
                practices.forEach(p => {
                    typeCount[p.type] = (typeCount[p.type] || 0) + 1;
                });

                const mostCommon = Object.entries(typeCount).sort((a, b) => b[1] - a[1])[0];

                statsDiv.innerHTML = `
                    <p><strong>Estat√≠sticas gerais:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Total de pr√°ticas: ${practices.length}</li>
                        <li>Tempo total: ${totalMinutes} minutos (${(totalMinutes / 60).toFixed(1)}h)</li>
                        <li>Dura√ß√£o m√©dia: ${avgDuration} minutos</li>
                        <li>Pr√°ticas este m√™s: ${thisMonthPractices.length}</li>
                        ${mostCommon ? `<li>Tipo mais praticado: ${mostCommon[0]} (${mostCommon[1]}x)</li>` : ''}
                    </ul>
                `;
            },

            async loadSessionHistory() {
                const sessions = await this.store.getAll('sessions');
                const historyDiv = document.getElementById('sessionHistory');

                if (sessions.length === 0) {
                    historyDiv.innerHTML = '<p>Nenhuma sess√£o registrada ainda.</p>';
                    return;
                }

                const recent = sessions.slice(-5).reverse();
                historyDiv.innerHTML = recent.map(s => `
                    <div class="note-card">
                        <div class="note-date">Sess√£o de ${new Date(s.date).toLocaleDateString('pt-BR')}</div>
                        <p><strong>Resumo:</strong> ${s.summary}</p>
                        ${s.homework ? `<p><strong>Tarefas:</strong> ${s.homework}</p>` : ''}
                        ${s.insights ? `<p><strong>Insights:</strong> ${s.insights}</p>` : ''}
                    </div>
                `).join('');
            },

            async saveRoutineState(state) {
                const today = new Date().toISOString().split('T')[0];
                await this.store.setMetadata(`routine_${today}`, state);
            },

            async loadRoutineState() {
                const today = new Date().toISOString().split('T')[0];
                const state = await this.store.getMetadata(`routine_${today}`);
                return state || {};
            }
        };

        // ============================================================================
        // UI FUNCTIONS
        // ============================================================================

        function updateDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent =
                new Date().toLocaleDateString('pt-BR', options);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            App.store.setMetadata('darkMode', document.body.classList.contains('dark-mode'));
        }

        function switchTab(tabName, trigger) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.toggle('active', tab.id === tabName);
            });

            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(nav => nav.classList.remove('active'));

            if (trigger) {
                trigger.classList.add('active');
            }
        }

        function selectMood(value, element) {
            document.querySelectorAll('.mood-emoji').forEach(emoji => {
                emoji.classList.remove('selected');
            });
            element.classList.add('selected');
            App.currentMood = value;
        }

        // Quick mood registration (1-click)
        async function saveMoodQuick(value) {
            const mood = Schema.Mood.create(value, '');

            try {
                await App.store.save('moods', mood);

                // Analytics tracking
                trackEvent('registro_humor', {
                    valor_humor: value,
                    tipo_registro: 'quick',
                    timestamp: new Date().toISOString()
                });

                // Visual feedback
                const emojis = ['', 'üòî', 'üòï', 'üòê', 'üôÇ', 'üòä'];
                showNotification(`Humor registrado! ${emojis[value]}`, 'success');

                // Update all visualizations
                await App.updateDashboard();
                await App.renderMoodChart(App.currentPeriod);
            } catch (error) {
                showNotification('Erro ao salvar: ' + error.message, 'error');
            }
        }

        // Show detailed mood form
        function showDetailedMoodForm() {
            const form = document.getElementById('detailedMoodForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        // Save mood with note (detailed form)
        async function saveMood() {
            if (!App.currentMood) {
                showNotification('Selecione um humor primeiro!', 'error');
                return;
            }

            const note = document.getElementById('moodNote').value;
            const mood = Schema.Mood.create(App.currentMood, note);

            const validation = Schema.Mood.validate(mood);
            if (!validation.valid) {
                showNotification(validation.error, 'error');
                return;
            }

            try {
                await App.store.save('moods', mood);

                // Analytics tracking
                trackEvent('registro_humor', {
                    valor_humor: App.currentMood,
                    tipo_registro: 'detailed',
                    com_nota: note.length > 0,
                    timestamp: new Date().toISOString()
                });

                showNotification('Humor registrado com sucesso! üéâ', 'success');

                // Clear form
                document.querySelectorAll('#detailedMoodForm .mood-emoji').forEach(e => e.classList.remove('selected'));
                document.getElementById('moodNote').value = '';
                document.getElementById('detailedMoodForm').style.display = 'none';
                App.currentMood = null;

                // Update all visualizations
                await App.updateDashboard();
                await App.renderMoodChart(App.currentPeriod);
            } catch (error) {
                showNotification('Erro ao salvar: ' + error.message, 'error');
            }
        }

        async function saveEmotion() {
            const type = document.getElementById('emotionType').value;
            const intensity = document.getElementById('emotionIntensity').value;
            const trigger = document.getElementById('emotionTrigger').value;
            const physical = document.getElementById('physicalSensations').value;
            const thoughts = document.getElementById('emotionThoughts').value;
            const urge = document.getElementById('actionUrge').value;

            const emotion = Schema.Emotion.create(type, intensity, {
                trigger, physical, thoughts, urge
            });

            const validation = Schema.Emotion.validate(emotion);
            if (!validation.valid) {
                showFieldError('emotionType', validation.error);
                return;
            }

            try {
                await App.store.save('emotions', emotion);
                showNotification('Emo√ß√£o registrada com sucesso! üéâ', 'success');

                // Clear form
                document.getElementById('emotionType').value = '';
                document.getElementById('emotionIntensity').value = 5;
                document.getElementById('intensityValue').textContent = '5';
                document.getElementById('emotionTrigger').value = '';
                document.getElementById('physicalSensations').value = '';
                document.getElementById('emotionThoughts').value = '';
                document.getElementById('actionUrge').value = '';
                clearFieldError('emotionType');

                // Update all visualizations
                await App.loadEmotionHistory();
                await App.updateDashboard();
            } catch (error) {
                showNotification('Erro ao salvar: ' + error.message, 'error');
            }
        }

        async function changeMoodPeriod(days) {
            App.currentPeriod = days;
            await App.renderMoodChart(days);
        }

        async function savePractice() {
            const type = document.getElementById('practiceType').value;
            const duration = document.getElementById('practiceDuration').value;
            const notes = document.getElementById('practiceNotes').value;

            const practice = Schema.Practice.create(type, duration, notes);

            const validation = Schema.Practice.validate(practice);
            if (!validation.valid) {
                if (!type) showFieldError('practiceType', validation.error);
                if (!duration) showFieldError('practiceDuration', 'Insira a dura√ß√£o');
                return;
            }

            try {
                await App.store.save('practices', practice);

                // Analytics tracking
                trackEvent('pratica_mindfulness', {
                    tipo_pratica: type,
                    duracao_minutos: parseInt(duration),
                    com_notas: notes.length > 0,
                    timestamp: new Date().toISOString()
                });

                showNotification('Pr√°tica registrada com sucesso! üéâ', 'success');

                // Clear form
                document.getElementById('practiceType').value = '';
                document.getElementById('practiceDuration').value = '';
                document.getElementById('practiceNotes').value = '';
                clearFieldError('practiceType');
                clearFieldError('practiceDuration');

                await App.loadPracticeHistory();
                await App.updatePracticeStats();
            } catch (error) {
                showNotification('Erro ao salvar: ' + error.message, 'error');
            }
        }

        async function saveSession() {
            const date = document.getElementById('sessionDate').value;
            const summary = document.getElementById('sessionSummary').value;
            const homework = document.getElementById('sessionHomework').value;
            const insights = document.getElementById('sessionInsights').value;

            const session = Schema.Session.create(date, summary, homework, insights);

            const validation = Schema.Session.validate(session);
            if (!validation.valid) {
                if (!date) showFieldError('sessionDate', validation.error);
                if (!summary) showFieldError('sessionSummary', 'Adicione um resumo');
                return;
            }

            try {
                await App.store.save('sessions', session);
                showNotification('Sess√£o salva com sucesso! üéâ', 'success');

                // Clear form
                document.getElementById('sessionDate').value = '';
                document.getElementById('sessionSummary').value = '';
                document.getElementById('sessionHomework').value = '';
                document.getElementById('sessionInsights').value = '';
                clearFieldError('sessionDate');
                clearFieldError('sessionSummary');

                await App.loadSessionHistory();
                await App.updateStats();
            } catch (error) {
                showNotification('Erro ao salvar: ' + error.message, 'error');
            }
        }

        // ============================================================================
        // ROUTINE FUNCTIONS
        // ============================================================================

        const defaultRoutineActivities = [
            { time: '08:00', title: 'Acordar e tomar caf√©', description: 'Cuidar dos cachorros' },
            { time: '08:30', title: 'Exerc√≠cio/Caminhada', description: '30 minutos de atividade f√≠sica' },
            { time: '09:00', title: 'Trabalho/Estudo', description: 'Foco nas atividades principais' },
            { time: '12:00', title: 'Almo√ßo', description: 'Pausa para refei√ß√£o' },
            { time: '14:00', title: 'Trabalho/Estudo', description: 'Continuar projetos' },
            { time: '16:00', title: 'Pausa/Cuidados', description: 'Momento de autocuidado' },
            { time: '18:00', title: 'Atividade Livre', description: 'Hobby ou descanso' },
            { time: '20:00', title: 'Jantar', description: 'Refei√ß√£o noturna' },
            { time: '22:00', title: 'Mindfulness', description: 'Pr√°tica antes de dormir' },
            { time: '23:30', title: 'Dormir', description: 'Descanso necess√°rio' }
        ];

        // Temporary storage for config being edited
        let currentConfigActivities = null;

        // Load routine configuration (or create default)
        async function loadRoutineConfig() {
            let config = await App.store.getMetadata('routineConfig');
            if (!config) {
                // First time - create default config
                config = {
                    activities: defaultRoutineActivities.map((a, i) => ({
                        id: 'act_' + Date.now() + '_' + i,
                        time: a.time,
                        title: a.title,
                        description: a.description,
                        enabled: true
                    })),
                    version: 1,
                    lastUpdated: new Date().toISOString()
                };
                await App.store.setMetadata('routineConfig', config);
            }
            return config;
        }

        // Render activity configuration list
        function renderActivityConfigList(activities) {
            const container = document.getElementById('activityConfigList');
            container.innerHTML = activities.map((activity, index) => `
                <div class="activity-config-item" data-id="${activity.id}">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <label style="min-width: 80px; margin: 0;">Hor√°rio:</label>
                        <input type="time" value="${activity.time}"
                               onchange="updateActivityField('${activity.id}', 'time', this.value)"
                               style="flex: 1;">
                    </div>
                    <div style="margin-bottom: 8px;">
                        <label style="display: block; margin-bottom: 5px;">T√≠tulo:</label>
                        <input type="text" value="${activity.title}"
                               onchange="updateActivityField('${activity.id}', 'title', this.value)"
                               placeholder="Ex: Acordar e tomar caf√©">
                    </div>
                    <div style="margin-bottom: 8px;">
                        <label style="display: block; margin-bottom: 5px;">Descri√ß√£o:</label>
                        <input type="text" value="${activity.description}"
                               onchange="updateActivityField('${activity.id}', 'description', this.value)"
                               placeholder="Ex: Cuidar dos cachorros">
                    </div>
                    <div class="activity-config-controls">
                        ${index > 0 ? `<button class="btn-move" onclick="moveActivityUp('${activity.id}')">‚Üë</button>` : ''}
                        ${index < activities.length - 1 ? `<button class="btn-move" onclick="moveActivityDown('${activity.id}')">‚Üì</button>` : ''}
                        <button class="btn-remove" onclick="removeActivity('${activity.id}')">üóëÔ∏è Remover</button>
                    </div>
                </div>
            `).join('');
        }

        // Load current config into temp storage when modal opens
        async function openRoutineConfigModal() {
            const config = await loadRoutineConfig();
            currentConfigActivities = JSON.parse(JSON.stringify(config.activities)); // Deep copy
            renderActivityConfigList(currentConfigActivities);
            document.getElementById('routineConfigModal').classList.add('active');
        }

        // Close routine configuration modal
        function closeRoutineConfigModal() {
            document.getElementById('routineConfigModal').classList.remove('active');
        }

        // Update activity field
        function updateActivityField(id, field, value) {
            const activity = currentConfigActivities.find(a => a.id === id);
            if (activity) {
                activity[field] = value;
            }
        }

        // Add new activity
        function addNewActivity() {
            const newActivity = {
                id: 'act_' + Date.now(),
                time: '12:00',
                title: 'Nova Atividade',
                description: 'Descri√ß√£o da atividade',
                enabled: true
            };
            currentConfigActivities.push(newActivity);
            renderActivityConfigList(currentConfigActivities);
        }

        // Remove activity
        function removeActivity(id) {
            if (currentConfigActivities.length <= 1) {
                showNotification('Voc√™ precisa ter pelo menos uma atividade!', 'error');
                return;
            }
            if (confirm('Remover esta atividade?')) {
                currentConfigActivities = currentConfigActivities.filter(a => a.id !== id);
                renderActivityConfigList(currentConfigActivities);
            }
        }

        // Move activity up
        function moveActivityUp(id) {
            const index = currentConfigActivities.findIndex(a => a.id === id);
            if (index > 0) {
                [currentConfigActivities[index - 1], currentConfigActivities[index]] =
                [currentConfigActivities[index], currentConfigActivities[index - 1]];
                renderActivityConfigList(currentConfigActivities);
            }
        }

        // Move activity down
        function moveActivityDown(id) {
            const index = currentConfigActivities.findIndex(a => a.id === id);
            if (index < currentConfigActivities.length - 1) {
                [currentConfigActivities[index], currentConfigActivities[index + 1]] =
                [currentConfigActivities[index + 1], currentConfigActivities[index]];
                renderActivityConfigList(currentConfigActivities);
            }
        }

        // Save routine configuration
        async function saveRoutineConfig() {
            const config = {
                activities: currentConfigActivities,
                version: 1,
                lastUpdated: new Date().toISOString()
            };
            await App.store.setMetadata('routineConfig', config);
            await renderRoutine();
            closeRoutineConfigModal();
            showNotification('Rotina atualizada com sucesso! üéâ', 'success');
        }

        // Reset to default routine
        async function resetToDefaultRoutine() {
            if (confirm('Restaurar rotina padr√£o? Suas personaliza√ß√µes ser√£o perdidas.')) {
                const config = {
                    activities: defaultRoutineActivities.map((a, i) => ({
                        id: 'act_' + Date.now() + '_' + i,
                        time: a.time,
                        title: a.title,
                        description: a.description,
                        enabled: true
                    })),
                    version: 1,
                    lastUpdated: new Date().toISOString()
                };
                await App.store.setMetadata('routineConfig', config);
                currentConfigActivities = JSON.parse(JSON.stringify(config.activities));
                renderActivityConfigList(currentConfigActivities);
                await renderRoutine();
                showNotification('Rotina restaurada para o padr√£o!', 'success');
            }
        }

        // Render routine (uses custom config)
        async function renderRoutine() {
            const config = await loadRoutineConfig();
            const routineState = await App.loadRoutineState();
            const container = document.getElementById('routineActivities');

            container.innerHTML = config.activities.map((activity, index) => {
                const isCompleted = routineState[activity.id] || false;
                return `
                    <div class="dashboard-card" style="margin-bottom: 15px; cursor: pointer; transition: all 0.3s; ${isCompleted ? 'background: linear-gradient(135deg, rgba(130, 202, 157, 0.2) 0%, rgba(130, 202, 157, 0.1) 100%); border-left: 4px solid #82ca9d;' : ''}" onclick="toggleActivity('${activity.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-weight: bold; color: var(--primary); min-width: 60px;">${activity.time}</span>
                                    <div>
                                        <strong>${activity.title}</strong>
                                        <p style="font-size: 13px; color: #666; margin-top: 3px;">${activity.description}</p>
                                    </div>
                                </div>
                            </div>
                            <span style="font-size: 24px;">${isCompleted ? '‚úÖ' : '‚¨ú'}</span>
                        </div>
                    </div>
                `;
            }).join('');

            updateRoutineProgress(routineState, config.activities);
        }

        async function toggleActivity(id) {
            const routineState = await App.loadRoutineState();
            routineState[id] = !routineState[id];
            await App.saveRoutineState(routineState);
            await renderRoutine();
        }

        async function updateRoutineProgress(routineState, activities) {
            const completed = Object.values(routineState).filter(v => v).length;
            const total = activities.length;
            const percentage = Math.round((completed / total) * 100);

            const progressBar = document.getElementById('routineProgress');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
        }

        async function resetRoutine() {
            if (confirm('Resetar todas as atividades do dia?')) {
                await App.saveRoutineState({});
                await renderRoutine();
                showNotification('Rotina resetada!', 'success');
            }
        }

        // ============================================================================
        // SKILLS & ACCEPTS FUNCTIONS
        // ============================================================================

        function showSkillDetails(skillName) {
            const modal = document.getElementById('skillModal');
            const title = document.getElementById('skillModalTitle');
            const content = document.getElementById('skillModalContent');

            const skills = {
                dearman: {
                    title: 'DEAR MAN - Efetividade Interpessoal',
                    content: `
                        <h3>Como usar DEAR MAN:</h3>
                        <div style="margin-top: 15px;">
                            <p style="margin-bottom: 10px;"><strong>D</strong>escrever - Descreva a situa√ß√£o de forma objetiva, sem julgamentos</p>
                            <p style="margin-bottom: 10px;"><strong>E</strong>xpressar - Expresse seus sentimentos e opini√µes claramente</p>
                            <p style="margin-bottom: 10px;"><strong>A</strong>firmar - Afirme o que voc√™ quer ou precisa de forma espec√≠fica</p>
                            <p style="margin-bottom: 10px;"><strong>R</strong>efor√ßar - Reforce explicando os benef√≠cios positivos</p>
                            <hr style="margin: 20px 0;">
                            <p style="margin-bottom: 10px;"><strong>M</strong>indful - Mantenha-se focado no seu objetivo</p>
                            <p style="margin-bottom: 10px;"><strong>A</strong>ppear confident - Apare√ßa confiante (postura, tom de voz)</p>
                            <p style="margin-bottom: 10px;"><strong>N</strong>egotiate - Esteja disposto a negociar e fazer concess√µes</p>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: rgba(107, 91, 149, 0.1); border-radius: 10px;">
                            <p style="font-size: 13px;"><strong>Exemplo:</strong> "Quando voc√™ chegou tarde sem avisar (D), eu fiquei preocupado (E). Eu gostaria que voc√™ me avisasse quando houver atrasos (A). Isso vai me deixar mais tranquilo e melhorar nossa rela√ß√£o (R)."</p>
                        </div>
                    `
                },
                tipp: {
                    title: 'TIPP - Habilidades de Crise',
                    content: `
                        <h3>Mudar a qu√≠mica corporal rapidamente:</h3>
                        <div style="margin-top: 15px;">
                            <p style="margin-bottom: 10px;"><strong>T</strong>emperature - Mude a temperatura do corpo (√°gua gelada no rosto, banho frio)</p>
                            <p style="margin-bottom: 10px;"><strong>I</strong>ntense exercise - Exerc√≠cio intenso (corrida, polichinelos, burpees)</p>
                            <p style="margin-bottom: 10px;"><strong>P</strong>aced breathing - Respira√ß√£o compassada (inspire 4s, segure 4s, expire 6s)</p>
                            <p style="margin-bottom: 10px;"><strong>P</strong>aired muscle relaxation - Tensione e relaxe grupos musculares progressivamente</p>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: rgba(255, 107, 107, 0.1); border-radius: 10px;">
                            <p style="font-size: 13px;"><strong>‚ö†Ô∏è Use TIPP quando:</strong> Emo√ß√µes est√£o muito intensas (8-10) e voc√™ precisa reduzir rapidamente para pensar com clareza.</p>
                        </div>
                    `
                },
                stop: {
                    title: 'STOP - Regula√ß√£o Emocional',
                    content: `
                        <h3>Pausar antes de agir impulsivamente:</h3>
                        <div style="margin-top: 15px;">
                            <p style="margin-bottom: 10px;"><strong>S</strong>top - Pare! N√£o reaja imediatamente. Congele por um momento.</p>
                            <p style="margin-bottom: 10px;"><strong>T</strong>ake a step back - D√™ um passo atr√°s, tanto literal quanto mentalmente. Respire.</p>
                            <p style="margin-bottom: 10px;"><strong>O</strong>bserve - Observe o que est√° acontecendo dentro e fora de voc√™. Nomeie a emo√ß√£o.</p>
                            <p style="margin-bottom: 10px;"><strong>P</strong>roceed mindfully - Prossiga conscientemente. Pergunte: "Qual a√ß√£o √© efetiva agora?"</p>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: rgba(130, 202, 157, 0.1); border-radius: 10px;">
                            <p style="font-size: 13px;"><strong>üí° Dica:</strong> STOP √© especialmente √∫til quando voc√™ sente um impulso forte de fazer algo que pode ter consequ√™ncias negativas.</p>
                        </div>
                    `
                },
                accepts: {
                    title: 'ACCEPTS - Toler√¢ncia ao Mal-estar',
                    content: `
                        <h3>Distrair-se de emo√ß√µes dolorosas:</h3>
                        <div style="margin-top: 15px;">
                            <p style="margin-bottom: 10px;"><strong>A</strong>ctivities - Fa√ßa atividades que ocupem sua mente</p>
                            <p style="margin-bottom: 10px;"><strong>C</strong>ontributing - Contribua, ajude outras pessoas</p>
                            <p style="margin-bottom: 10px;"><strong>C</strong>omparisons - Compare com momentos piores ou com outras pessoas</p>
                            <p style="margin-bottom: 10px;"><strong>E</strong>motions - Provoque emo√ß√µes opostas (com√©dia se est√° triste)</p>
                            <p style="margin-bottom: 10px;"><strong>P</strong>ushing away - Afaste temporariamente os pensamentos dolorosos</p>
                            <p style="margin-bottom: 10px;"><strong>T</strong>houghts - Pense em outras coisas (contar, quebra-cabe√ßa)</p>
                            <p style="margin-bottom: 10px;"><strong>S</strong>ensations - Use sensa√ß√µes f√≠sicas intensas (gelo, m√∫sica alta)</p>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: rgba(255, 180, 71, 0.1); border-radius: 10px;">
                            <p style="font-size: 13px;"><strong>üìå Lembre-se:</strong> Preencha sua Carta ACCEPTS personalizada abaixo com estrat√©gias que funcionam especificamente para voc√™!</p>
                        </div>
                    `
                }
            };

            const skillData = skills[skillName];
            title.textContent = skillData.title;
            content.innerHTML = skillData.content;
            modal.classList.add('active');
        }

        function closeSkillModal() {
            document.getElementById('skillModal').classList.remove('active');
        }

        async function saveAcceptsCard() {
            const accepts = {
                activities: document.getElementById('acceptsActivities').value,
                contribute: document.getElementById('acceptsContribute').value,
                compare: document.getElementById('acceptsCompare').value,
                emotions: document.getElementById('acceptsEmotions').value,
                pushing: document.getElementById('acceptsPushing').value,
                thoughts: document.getElementById('acceptsThoughts').value,
                sensations: document.getElementById('acceptsSensations').value
            };

            await App.store.setMetadata('acceptsCard', accepts);
            showNotification('Carta ACCEPTS salva com sucesso! üéâ', 'success');
        }

        async function loadAcceptsCard() {
            const accepts = await App.store.getMetadata('acceptsCard');
            if (accepts) {
                document.getElementById('acceptsActivities').value = accepts.activities || '';
                document.getElementById('acceptsContribute').value = accepts.contribute || '';
                document.getElementById('acceptsCompare').value = accepts.compare || '';
                document.getElementById('acceptsEmotions').value = accepts.emotions || '';
                document.getElementById('acceptsPushing').value = accepts.pushing || '';
                document.getElementById('acceptsThoughts').value = accepts.thoughts || '';
                document.getElementById('acceptsSensations').value = accepts.sensations || '';
            }
        }

        // ============================================================================
        // PDF EXPORT FUNCTION
        // ============================================================================

        async function exportPDF() {
            try {
                showNotification('Gerando relat√≥rio PDF...', 'success');

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Get data
                const moods = await App.store.getAll('moods');
                const emotions = await App.store.getAll('emotions');
                const practices = await App.store.getAll('practices');
                const sessions = await App.store.getAll('sessions');

                // Calculate date range (last 7 days)
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                const weekMoods = moods.filter(m => new Date(m.date) >= sevenDaysAgo);
                const weekEmotions = emotions.filter(e => new Date(e.date) >= sevenDaysAgo);
                const weekPractices = practices.filter(p => new Date(p.date) >= sevenDaysAgo);

                // Title
                doc.setFontSize(20);
                doc.text('Relatorio Terapeutico Semanal', 20, 20);

                doc.setFontSize(12);
                doc.text(`Periodo: ${sevenDaysAgo.toLocaleDateString('pt-BR')} a ${today.toLocaleDateString('pt-BR')}`, 20, 30);

                // Mood summary
                let y = 45;
                doc.setFontSize(14);
                doc.text('Resumo de Humor', 20, y);
                y += 10;

                if (weekMoods.length > 0) {
                    const avgMood = (weekMoods.reduce((sum, m) => sum + m.value, 0) / weekMoods.length).toFixed(1);
                    doc.setFontSize(11);
                    doc.text(`- Total de registros: ${weekMoods.length}`, 25, y);
                    y += 7;
                    doc.text(`- Humor medio: ${avgMood}/5`, 25, y);
                    y += 7;
                } else {
                    doc.setFontSize(11);
                    doc.text('Nenhum registro de humor neste periodo', 25, y);
                    y += 7;
                }

                // Emotions summary
                y += 5;
                doc.setFontSize(14);
                doc.text('Emocoes Registradas', 20, y);
                y += 10;

                if (weekEmotions.length > 0) {
                    const emotionCounts = {};
                    weekEmotions.forEach(e => {
                        emotionCounts[e.type] = (emotionCounts[e.type] || 0) + 1;
                    });

                    doc.setFontSize(11);
                    doc.text(`- Total de registros: ${weekEmotions.length}`, 25, y);
                    y += 7;

                    const topEmotions = Object.entries(emotionCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
                    doc.text('- Emocoes mais frequentes:', 25, y);
                    y += 7;

                    topEmotions.forEach(([emotion, count]) => {
                        doc.text(`  ${emotion}: ${count}x`, 30, y);
                        y += 6;
                    });
                } else {
                    doc.setFontSize(11);
                    doc.text('Nenhuma emocao registrada neste periodo', 25, y);
                    y += 7;
                }

                // Practices summary
                y += 5;
                doc.setFontSize(14);
                doc.text('Praticas de Mindfulness', 20, y);
                y += 10;

                if (weekPractices.length > 0) {
                    const totalMinutes = weekPractices.reduce((sum, p) => sum + parseInt(p.duration), 0);
                    doc.setFontSize(11);
                    doc.text(`- Total de praticas: ${weekPractices.length}`, 25, y);
                    y += 7;
                    doc.text(`- Tempo total: ${totalMinutes} minutos (${(totalMinutes / 60).toFixed(1)}h)`, 25, y);
                    y += 7;
                } else {
                    doc.setFontSize(11);
                    doc.text('Nenhuma pratica registrada neste periodo', 25, y);
                    y += 7;
                }

                // Sessions
                if (sessions.length > 0) {
                    y += 5;
                    doc.setFontSize(14);
                    doc.text('Ultima Sessao Terapeutica', 20, y);
                    y += 10;

                    const lastSession = sessions[sessions.length - 1];
                    doc.setFontSize(11);
                    doc.text(`Data: ${new Date(lastSession.date).toLocaleDateString('pt-BR')}`, 25, y);
                    y += 7;

                    if (lastSession.summary) {
                        doc.text('Resumo:', 25, y);
                        y += 7;
                        const summaryLines = doc.splitTextToSize(lastSession.summary, 160);
                        doc.text(summaryLines, 30, y);
                        y += (summaryLines.length * 6);
                    }
                }

                // Footer
                doc.setFontSize(9);
                doc.text(`Gerado em ${new Date().toLocaleString('pt-BR')}`, 20, 280);

                // Save PDF
                doc.save(`relatorio-terapeutico-${today.toISOString().split('T')[0]}.pdf`);

                // Analytics tracking
                trackEvent('exportacao_pdf', {
                    periodo_selecionado: '7_dias',
                    total_registros_humor: weekMoods.length,
                    total_emocoes: weekEmotions.length,
                    total_praticas: weekPractices.length,
                    timestamp: new Date().toISOString()
                });

                showNotification('Relat√≥rio PDF gerado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showNotification('Erro ao gerar PDF: ' + error.message, 'error');
            }
        }

        async function exportBackup() {
            try {
                const data = await App.store.exportAll();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `therapy-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                await App.store.setMetadata('lastBackup', new Date().toISOString());
                await App.updateBackupBadge();

                showNotification('Backup baixado com sucesso!', 'success');
            } catch (error) {
                showNotification('Erro ao exportar: ' + error.message, 'error');
            }
        }

        async function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (!confirm('‚ö†Ô∏è Isso ir√° substituir todos os dados atuais. Continuar?')) {
                    return;
                }

                await App.store.importAll(data);
                showNotification('Backup restaurado com sucesso!', 'success');

                // Reload all data
                await App.updateDashboard();
                await App.loadEmotionHistory();
                await App.updateStats();
                await App.updateBackupBadge();
            } catch (error) {
                showNotification('Erro ao restaurar: ' + error.message, 'error');
            }
        }

        // TASK-015: Enhanced backup reminder modal
        function showBackupModal() {
            const modal = document.getElementById('backupReminderModal');
            modal.classList.add('active');

            // Calculate days since last backup
            App.store.getMetadata('lastBackup').then(lastBackup => {
                const daysSinceEl = document.getElementById('daysSinceBackup');
                if (!lastBackup) {
                    daysSinceEl.textContent = 'nunca';
                } else {
                    const days = Math.floor((Date.now() - new Date(lastBackup)) / (1000 * 60 * 60 * 24));
                    daysSinceEl.textContent = `${days} ${days === 1 ? 'dia' : 'dias'}`;
                }
            });
        }

        function closeBackupReminderModal() {
            document.getElementById('backupReminderModal').classList.remove('active');
        }

        function exportBackupFromModal() {
            exportBackup();
            closeBackupReminderModal();
        }

        function remindBackupLater() {
            // Snooze for 1 day
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            localStorage.setItem('backupSnoozeUntil', tomorrow.toISOString());

            showNotification('Ok! Lembrarei voc√™ amanh√£', 'success');
            closeBackupReminderModal();
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(fieldId + 'Error');

            field.classList.add('error');
            if (error) {
                error.textContent = message;
                error.classList.add('visible');
            }
        }

        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(fieldId + 'Error');

            field.classList.remove('error');
            if (error) {
                error.classList.remove('visible');
            }
        }

        function formatDateTime(isoString) {
            return new Date(isoString).toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Update intensity display
        document.addEventListener('DOMContentLoaded', () => {
            const intensitySlider = document.getElementById('emotionIntensity');
            if (intensitySlider) {
                intensitySlider.addEventListener('input', function() {
                    document.getElementById('intensityValue').textContent = this.value;
                });
            }
        });

        // ============================================================================
        // ONBOARDING SYSTEM
        // ============================================================================

        let currentOnboardingStep = 1;
        let selectedOnboardingMood = null;

        function showOnboarding() {
            const onboardingCompleted = localStorage.getItem('onboardingCompleted');
            if (!onboardingCompleted) {
                document.getElementById('onboardingModal').classList.add('active');
                trackEvent('onboarding_iniciado', {
                    timestamp: new Date().toISOString()
                });
            }
        }

        function selectOnboardingMood(value) {
            selectedOnboardingMood = value;

            // Visual feedback - highlight selected
            document.querySelectorAll('#step1 .mood-emoji').forEach(emoji => {
                emoji.classList.remove('selected');
            });
            event.target.classList.add('selected');

            // Update feedback text
            const emojis = ['', 'üòî Entendi...', 'üòï Vamos melhorar!', 'üòê Certo!', 'üôÇ Que bom!', 'üòä √ìtimo!'];
            document.getElementById('moodFeedback').textContent = emojis[value];
            document.getElementById('moodFeedback').style.color = value >= 4 ? 'var(--success)' : 'var(--primary)';

            // Enable next button
            document.getElementById('btnNext').disabled = false;
        }

        function nextStep() {
            // Step 1 -> Step 2
            if (currentOnboardingStep === 1) {
                if (!selectedOnboardingMood) {
                    showNotification('Por favor, selecione seu humor!', 'error');
                    return;
                }

                // Save first mood
                const mood = Schema.Mood.create(selectedOnboardingMood, 'Primeiro registro (onboarding)');
                App.store.save('moods', mood).then(() => {
                    trackEvent('onboarding_step_1_completo', {
                        humor_selecionado: selectedOnboardingMood,
                        timestamp: new Date().toISOString()
                    });
                });

                currentOnboardingStep = 2;
                updateOnboardingUI();
            }
            // Step 2 -> Step 3
            else if (currentOnboardingStep === 2) {
                trackEvent('onboarding_step_2_visualizado', {
                    timestamp: new Date().toISOString()
                });
                currentOnboardingStep = 3;
                updateOnboardingUI();
            }
            // Step 3 -> Finish
            else if (currentOnboardingStep === 3) {
                finishOnboarding();
            }
        }

        function prevStep() {
            if (currentOnboardingStep > 1) {
                currentOnboardingStep--;
                updateOnboardingUI();
            }
        }

        function updateOnboardingUI() {
            // Hide all steps
            document.querySelectorAll('.onboarding-step').forEach(step => {
                step.classList.remove('active');
            });

            // Show current step
            document.getElementById(`step${currentOnboardingStep}`).classList.add('active');

            // Update progress bar
            for (let i = 1; i <= 3; i++) {
                const progressStep = document.getElementById(`progress${i}`);
                if (i <= currentOnboardingStep) {
                    progressStep.classList.add('active');
                } else {
                    progressStep.classList.remove('active');
                }
            }

            // Update buttons
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');

            // Show/hide previous button
            btnPrev.style.display = currentOnboardingStep > 1 ? 'block' : 'none';

            // Update next button text and state
            if (currentOnboardingStep === 1) {
                btnNext.textContent = 'Pr√≥ximo ‚Üí';
                btnNext.disabled = !selectedOnboardingMood;
            } else if (currentOnboardingStep === 2) {
                btnNext.textContent = 'Pr√≥ximo ‚Üí';
                btnNext.disabled = false;
            } else if (currentOnboardingStep === 3) {
                btnNext.textContent = 'Finalizar üéâ';
                btnNext.disabled = false;
            }
        }

        function finishOnboarding() {
            // Save reminder preferences
            const email = document.getElementById('onboardingEmail').value;
            const reminderTime = document.getElementById('onboardingReminderTime').value;

            if (email || reminderTime) {
                localStorage.setItem('reminderEmail', email);
                localStorage.setItem('reminderTime', reminderTime);

                trackEvent('ativacao_lembrete', {
                    horario_escolhido: reminderTime,
                    email_fornecido: email.length > 0,
                    timestamp: new Date().toISOString()
                });
            }

            // Mark onboarding as completed
            localStorage.setItem('onboardingCompleted', 'true');

            // Track completion
            trackEvent('conclusao_onboarding', {
                etapa_final: 3,
                tempo_total: 0, // TODO: track actual time
                pulou: false,
                timestamp: new Date().toISOString()
            });

            // Close modal with animation
            document.getElementById('onboardingModal').classList.remove('active');

            // Show success notification
            showNotification('Bem-vindo(a)! Sua jornada come√ßou! üéâ', 'success');

            // Refresh dashboard
            App.updateDashboard();
        }

        function skipOnboarding() {
            if (confirm('Tem certeza que deseja pular o tutorial? Voc√™ pode acess√°-lo depois nas Configura√ß√µes.')) {
                localStorage.setItem('onboardingCompleted', 'true');

                trackEvent('onboarding_pulado', {
                    etapa_atual: currentOnboardingStep,
                    timestamp: new Date().toISOString()
                });

                document.getElementById('onboardingModal').classList.remove('active');
                showNotification('Voc√™ pode refazer o tutorial nas Configura√ß√µes.', 'success');
            }
        }

        // ============================================================================
        // NEW FEATURES - INSIGHTS, JOURNAL, RESOURCES, PROFILE
        // ============================================================================

        // Settings Section Switching
        function switchSettingsSection(section, element) {
            // Remove active class from all sidebar items
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to clicked item
            element.classList.add('active');

            // Hide all sections
            document.querySelectorAll('.settings-section').forEach(sec => {
                sec.style.display = 'none';
            });

            // Show selected section
            const sectionElement = document.getElementById(section + '-section');
            if (sectionElement) {
                sectionElement.style.display = 'block';
            }
        }

        // Profile Management
        function saveProfile() {
            const fullName = document.getElementById('profileFullName').value;
            const email = document.getElementById('profileEmail').value;

            // Save to localStorage
            localStorage.setItem('userProfile', JSON.stringify({
                fullName,
                email,
                updatedAt: new Date().toISOString()
            }));

            // Update sidebar
            document.getElementById('sidebarUserName').textContent = fullName;
            document.getElementById('sidebarUserEmail').textContent = email;
            document.getElementById('profileUserName').textContent = fullName;
            document.getElementById('profileUserEmail').textContent = email;

            showNotification('Profile updated successfully! üéâ', 'success');
        }

        function confirmDeleteAllData() {
            if (confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL your data. This action cannot be undone. Are you absolutely sure?')) {
                localStorage.clear();
                if (window.indexedDB) {
                    indexedDB.deleteDatabase('TherapyAppDB');
                }
                showNotification('All data has been deleted.', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                showNotification('Logged out successfully.', 'success');
                // In a real app, this would clear session and redirect
            }
        }

        function toggleNotification(type) {
            showNotification(`${type} notifications toggled`, 'success');
        }

        // Calendar Navigation (for Insights)
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();

        function renderCalendar() {
            const calendarDays = document.getElementById('calendarDays');
            if (!calendarDays) return;

            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const prevLastDay = new Date(currentCalendarYear, currentCalendarMonth, 0);

            const firstDayOfWeek = firstDay.getDay();
            const lastDate = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];

            document.getElementById('calendarMonth').textContent =
                `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;

            let daysHTML = '';

            // Previous month days
            for (let i = firstDayOfWeek; i > 0; i--) {
                daysHTML += `<div class="calendar-day other-month">${prevLastDate - i + 1}</div>`;
            }

            // Current month days
            const today = new Date();
            for (let i = 1; i <= lastDate; i++) {
                const isToday = i === today.getDate() &&
                              currentCalendarMonth === today.getMonth() &&
                              currentCalendarYear === today.getFullYear();
                const classes = ['calendar-day'];
                if (isToday) classes.push('today');
                // Check if has entry (simplified - in real app, check actual data)
                if (Math.random() > 0.7) classes.push('has-entry');

                daysHTML += `<div class="${classes.join(' ')}">${i}</div>`;
            }

            // Next month days
            const totalCells = Math.ceil((firstDayOfWeek + lastDate) / 7) * 7;
            const remainingCells = totalCells - (firstDayOfWeek + lastDate);
            for (let i = 1; i <= remainingCells; i++) {
                daysHTML += `<div class="calendar-day other-month">${i}</div>`;
            }

            calendarDays.innerHTML = daysHTML;
        }

        function prevMonth() {
            currentCalendarMonth--;
            if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarMonth++;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            }
            renderCalendar();
        }

        // Journal Calendar Navigation
        let currentJournalMonth = new Date().getMonth();
        let currentJournalYear = new Date().getFullYear();

        function renderJournalCalendar() {
            const calendarDays = document.getElementById('journalCalendarDays');
            if (!calendarDays) return;

            const firstDay = new Date(currentJournalYear, currentJournalMonth, 1);
            const lastDay = new Date(currentJournalYear, currentJournalMonth + 1, 0);
            const prevLastDay = new Date(currentJournalYear, currentJournalMonth, 0);

            const firstDayOfWeek = firstDay.getDay();
            const lastDate = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];

            document.getElementById('journalCalendarMonth').textContent =
                `${monthNames[currentJournalMonth]} ${currentJournalYear}`;

            let daysHTML = '';

            // Previous month days
            for (let i = firstDayOfWeek; i > 0; i--) {
                daysHTML += `<div class="calendar-day other-month">${prevLastDate - i + 1}</div>`;
            }

            // Current month days
            const today = new Date();
            for (let i = 1; i <= lastDate; i++) {
                const isToday = i === today.getDate() &&
                              currentJournalMonth === today.getMonth() &&
                              currentJournalYear === today.getFullYear();
                const classes = ['calendar-day'];
                if (isToday) classes.push('today');
                // Check if has entry (simplified)
                if (i === 24 || i === 25 || i === 26) classes.push('has-entry');

                daysHTML += `<div class="${classes.join(' ')}">${i}</div>`;
            }

            // Next month days
            const totalCells = Math.ceil((firstDayOfWeek + lastDate) / 7) * 7;
            const remainingCells = totalCells - (firstDayOfWeek + lastDate);
            for (let i = 1; i <= remainingCells; i++) {
                daysHTML += `<div class="calendar-day other-month">${i}</div>`;
            }

            calendarDays.innerHTML = daysHTML;
        }

        function journalPrevMonth() {
            currentJournalMonth--;
            if (currentJournalMonth < 0) {
                currentJournalMonth = 11;
                currentJournalYear--;
            }
            renderJournalCalendar();
        }

        function journalNextMonth() {
            currentJournalMonth++;
            if (currentJournalMonth > 11) {
                currentJournalMonth = 0;
                currentJournalYear++;
            }
            renderJournalCalendar();
        }

        function saveJournalEntry() {
            const content = document.getElementById('journalTextarea').value;
            if (!content.trim()) {
                showNotification('Please write something before saving', 'error');
                return;
            }

            // Save to localStorage
            const entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
            entries.push({
                id: generateId(),
                content: content,
                date: new Date().toISOString(),
                mood: 'üòä' // Could be selected from UI
            });
            localStorage.setItem('journalEntries', JSON.stringify(entries));

            showNotification('Journal entry saved! üìî', 'success');
        }

        function loadJournalEntry(date) {
            // In a real app, load the actual entry for the date
            showNotification('Loading entry for ' + date, 'success');
        }

        // Update word count in journal
        const journalTextarea = document.getElementById('journalTextarea');
        if (journalTextarea) {
            journalTextarea.addEventListener('input', function() {
                const words = this.value.trim().split(/\s+/).filter(w => w.length > 0).length;
                const wordCountElement = document.getElementById('journalWordCount');
                if (wordCountElement) {
                    wordCountElement.textContent = words + ' words';
                }
            });
        }

        // Resource Filtering
        function filterResources(category, element) {
            // Update active filter button
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            element.classList.add('active');

            // Filter resource cards
            const cards = document.querySelectorAll('.resource-card');
            cards.forEach(card => {
                if (category === 'all' || card.getAttribute('data-category') === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Period Selection for Insights
        function changePeriod(period, element) {
            // Update active button
            document.querySelectorAll('.period-option').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');

            showNotification(`Viewing ${period} data`, 'success');
            // In a real app, update charts and stats here
        }

        // Initialize new features when tab is switched
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tabName, element) {
            // Call original switchTab function
            if (originalSwitchTab) {
                originalSwitchTab(tabName, element);
            } else {
                // Fallback implementation
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                const tabElement = document.getElementById(tabName);
                if (tabElement) {
                    tabElement.classList.add('active');
                }
                if (element) {
                    element.classList.add('active');
                }
            }

            // Initialize features based on tab
            if (tabName === 'insights') {
                renderCalendar();
                initializeInsightsCharts();
            } else if (tabName === 'journal') {
                renderJournalCalendar();
            }
        };

        // Initialize Insights Charts
        function initializeInsightsCharts() {
            // Mood Trends Chart
            const moodChartCanvas = document.getElementById('insightsMoodChart');
            if (moodChartCanvas && typeof Chart !== 'undefined') {
                const ctx = moodChartCanvas.getContext('2d');

                // Destroy existing chart if it exists
                if (window.insightsMoodChart) {
                    window.insightsMoodChart.destroy();
                }

                window.insightsMoodChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Mood',
                            data: [3, 4, 3.5, 4.5, 5, 4, 4.5],
                            borderColor: '#4ade80',
                            backgroundColor: 'rgba(74, 222, 128, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5,
                                ticks: {
                                    color: '#a0a0a0'
                                },
                                grid: {
                                    color: '#2a3f3f'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#a0a0a0'
                                },
                                grid: {
                                    color: '#2a3f3f'
                                }
                            }
                        }
                    }
                });
            }

            // Emotional Intensity Donut Chart
            const intensityChartCanvas = document.getElementById('emotionalIntensityChart');
            if (intensityChartCanvas && typeof Chart !== 'undefined') {
                const ctx = intensityChartCanvas.getContext('2d');

                // Destroy existing chart if it exists
                if (window.emotionalIntensityChart) {
                    window.emotionalIntensityChart.destroy();
                }

                window.emotionalIntensityChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Happy', 'Anxious', 'Sad', 'Calm', 'Other'],
                        datasets: [{
                            data: [50, 50, 10, 10, 10],
                            backgroundColor: [
                                '#fbbf24',
                                '#60a5fa',
                                '#f87171',
                                '#a78bfa',
                                '#fb923c'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#a0a0a0',
                                    padding: 15
                                }
                            }
                        }
                    }
                });
            }
        }

        // ============================================================================
        // END NEW FEATURES
        // ============================================================================

        // Initialize app on load
        window.onload = () => {
            App.init();

            // Show onboarding for new users after a slight delay
            setTimeout(() => {
                showOnboarding();
            }, 500);
        };
    </script>
</body>
</html>
